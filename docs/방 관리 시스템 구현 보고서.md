# ğŸ® Socket.IO ë°© ê´€ë¦¬ ì‹œìŠ¤í…œ êµ¬í˜„ ë³´ê³ ì„œ

**ì‘ì„±ì¼**: 2025-10-21
**í”„ë¡œì íŠ¸**: ListenUp! - ì‹¤ì‹œê°„ ìŒì•… ë§ì¶”ê¸° ê²Œì„
**ì‘ì—… ë²”ìœ„**: ë°±ì—”ë“œ ë°© ê´€ë¦¬ ì‹œìŠ¤í…œ ë° Socket.IO ì‹¤ì‹œê°„ í†µì‹ 

---

## ğŸ“‹ ëª©ì°¨

1. [ì‘ì—… ê°œìš”](#ì‘ì—…-ê°œìš”)
2. [ì•„í‚¤í…ì²˜ ì„¤ê³„](#ì•„í‚¤í…ì²˜-ì„¤ê³„)
3. [êµ¬í˜„ ìƒì„¸](#êµ¬í˜„-ìƒì„¸)
4. [ê¸°ìˆ ì  ê²°ì •ì‚¬í•­](#ê¸°ìˆ ì -ê²°ì •ì‚¬í•­)
5. [ì‚¬ìš© ê°€ì´ë“œ](#ì‚¬ìš©-ê°€ì´ë“œ)
6. [í–¥í›„ í™•ì¥ ë°©ì•ˆ](#í–¥í›„-í™•ì¥-ë°©ì•ˆ)

---

## ì‘ì—… ê°œìš”

### ëª©í‘œ
ë©€í‹°í”Œë ˆì´ì–´ ê²Œì„ì„ ìœ„í•œ ì‹¤ì‹œê°„ ë°© ê´€ë¦¬ ì‹œìŠ¤í…œì„ êµ¬ì¶•í•©ë‹ˆë‹¤. ì‚¬ìš©ìë“¤ì´ ë¡œê·¸ì¸ ì—†ì´ ë°© ì½”ë“œë§Œìœ¼ë¡œ ì¦‰ì‹œ ê²Œì„ì— ì°¸ì—¬í•  ìˆ˜ ìˆëŠ” ì‹œìŠ¤í…œì„ ë§Œë“œëŠ” ê²ƒì´ í•µì‹¬ ëª©í‘œì…ë‹ˆë‹¤.

### ì™„ë£Œëœ ì‘ì—…
1. âœ… ë°© ê´€ë¦¬ ì„œë¹„ìŠ¤ (`RoomService`) êµ¬í˜„
2. âœ… Socket.IO ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ êµ¬í˜„
3. âœ… ì‹¤ì‹œê°„ ì–‘ë°©í–¥ í†µì‹  ì„¤ì •
4. âœ… ìë™ ì •ë¦¬ ë©”ì»¤ë‹ˆì¦˜ êµ¬í˜„

### ì£¼ìš” ê¸°ëŠ¥
- ë°© ìƒì„±/ì°¸ê°€/í‡´ì¥
- ì‹¤ì‹œê°„ í”Œë ˆì´ì–´ ìƒíƒœ ë™ê¸°í™”
- ë°©ì¥ ìë™ ìœ„ì„
- ì—°ê²° í•´ì œ ì‹œ ìë™ ì •ë¦¬

---

## ì•„í‚¤í…ì²˜ ì„¤ê³„

### 1. ì „ì²´ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Client (Browser)                      â”‚
â”‚                    Svelte + Socket.IO Client                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†• WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Server (Node.js)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   Socket.IO      â”‚ â†â”€â”€â”€â”€â†’  â”‚   RoomService    â”‚         â”‚
â”‚  â”‚   Handlers       â”‚         â”‚   (ë°© ê´€ë¦¬)       â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚           â†•                            â†•                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚         In-Memory Storage (Map)              â”‚          â”‚
â”‚  â”‚         rooms: Map<code, Room>               â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. ê³„ì¸µ êµ¬ì¡°

```
index.ts (ì§„ì…ì )
    â”‚
    â”œâ”€ Socket.IO ì„œë²„ ì´ˆê¸°í™”
    â”‚
    â””â”€ socket/handlers/
           â”‚
           â”œâ”€ room.handler.ts (ë°© ê´€ë¦¬ ì´ë²¤íŠ¸)
           â”‚      â†“
           â””â”€ services/room.ts (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§)
                  â†“
              types/index.ts (íƒ€ì… ì •ì˜)
```

### 3. ë°ì´í„° íë¦„

#### ë°© ìƒì„± í”„ë¡œì„¸ìŠ¤
```
1. Client: socket.emit("create-room", { nickname, settings })
        â†“
2. Server: handleCreateRoom() ì‹¤í–‰
        â†“
3. RoomService: createRoom() â†’ ë°© ìƒì„± ë° Mapì— ì €ì¥
        â†“
4. Socket: socket.join(roomCode) â†’ Socket.IO ë£¸ì— ì°¸ê°€
        â†“
5. Server â†’ Client: callback({ success: true, room })
```

#### í”Œë ˆì´ì–´ ì°¸ê°€ í”„ë¡œì„¸ìŠ¤
```
1. Client: socket.emit("join-room", { code, nickname })
        â†“
2. Server: handleJoinRoom() ì‹¤í–‰
        â†“
3. RoomService: joinRoom() â†’ ê²€ì¦ í›„ í”Œë ˆì´ì–´ ì¶”ê°€
        â†“
4. Socket: socket.join(code) â†’ Socket.IO ë£¸ì— ì°¸ê°€
        â†“
5. Server â†’ Client (ìš”ì²­ì): callback({ success: true, room })
        â†“
6. Server â†’ Other Clients: emit("player-joined", playerData)
```

---

## êµ¬í˜„ ìƒì„¸

### 1. RoomService (`services/room.ts`)

#### í•µì‹¬ ì„¤ê³„ ì›ì¹™

**1.1 ë©”ëª¨ë¦¬ ê¸°ë°˜ ì €ì¥ì†Œ**

```typescript
private rooms: Map<string, Room>;
```

**ì™œ Mapì„ ì‚¬ìš©í–ˆëŠ”ê°€?**
- **O(1) ì‹œê°„ë³µì¡ë„**: ë°© ì½”ë“œë¡œ ì§ì ‘ ì ‘ê·¼ (ë°°ì—´ì˜ ê²½ìš° O(n))
- **ë©”ëª¨ë¦¬ íš¨ìœ¨ì„±**: í‚¤-ê°’ ìŒìœ¼ë¡œ ì €ì¥í•˜ì—¬ ë¶ˆí•„ìš”í•œ íƒìƒ‰ ì œê±°
- **ì‚­ì œ ìš©ì´ì„±**: ë¹ˆ ë°©ì„ ì¦‰ì‹œ ì œê±° ê°€ëŠ¥
- **í™•ì¥ì„±**: ì¶”í›„ Redisë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œ êµ¬ì¡° ìœ ì‚¬

**ë‹¨ì  ë° ëŒ€ì•ˆ:**
- ì„œë²„ ì¬ì‹œì‘ ì‹œ ë°ì´í„° ì†ì‹¤ â†’ ì¶”í›„ Redis/Database ë„ì… í•„ìš”
- ë©”ëª¨ë¦¬ ì œí•œ â†’ í˜„ì¬ëŠ” ì ì€ ë™ì‹œ ì ‘ì†ì ê°€ì •

**1.2 ë°© ì½”ë“œ ìƒì„± ì „ëµ**

```typescript
private generateRoomCode(): string {
  return nanoid(6).toUpperCase();
}
```

**ê¸°ìˆ  ì„ íƒ: nanoid**
- **ì™œ UUIDê°€ ì•„ë‹Œê°€?**: UUIDëŠ” 36ìë¡œ ë„ˆë¬´ ê¸¸ê³  ì‚¬ìš©ìê°€ ì…ë ¥í•˜ê¸° ì–´ë ¤ì›€
- **ì™œ nanoidì¸ê°€?**:
  - ì§§ê³  ì½ê¸° ì‰¬ìš´ ID ìƒì„±
  - ì¶©ëŒ í™•ë¥  ê·¹íˆ ë‚®ìŒ (6ìë¦¬ ëŒ€ë¬¸ì: 62^6 = 56,800,235,584 ì¡°í•©)
  - ì•”í˜¸í•™ì ìœ¼ë¡œ ì•ˆì „í•œ ë‚œìˆ˜ ìƒì„±
- **ëŒ€ë¬¸ì ë³€í™˜ ì´ìœ **: ì‚¬ìš©ì ì…ë ¥ í¸ì˜ì„± (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ìŒ)

**1.3 í”Œë ˆì´ì–´ ê´€ë¦¬**

```typescript
players: Map<string, Player>
```

**ì™œ Mapì¸ê°€?**
- Socket IDë¥¼ í‚¤ë¡œ ì‚¬ìš©í•˜ì—¬ ë¹ ë¥¸ ì¡°íšŒ/ì‚­ì œ
- í”Œë ˆì´ì–´ ìˆ˜ í™•ì¸: `players.size`
- ìˆœíšŒ: `Array.from(players.values())`

**Player êµ¬ì¡°:**
```typescript
interface Player {
  id: string;          // Socket ID (ê³ ìœ )
  nickname: string;    // ì‚¬ìš©ì ì…ë ¥ (ì¤‘ë³µ ì²´í¬)
  avatar: string;      // ëœë¤ ì´ëª¨ì§€ (ì‹œê°ì  êµ¬ë¶„)
  score: number;       // ê²Œì„ ì ìˆ˜
  streak: number;      // ì—°ì† ì •ë‹µ ìŠ¤íŠ¸ë¦­
  isHost: boolean;     // ë°©ì¥ ì—¬ë¶€
  joinedAt: number;    // ì…ì¥ ì‹œê°„ (íƒ€ì„ìŠ¤íƒ¬í”„)
}
```

**ì„¤ê³„ ê·¼ê±°:**
- `id`: Socket ID ì‚¬ìš©ìœ¼ë¡œ ë³„ë„ ID ìƒì„± ë¶ˆí•„ìš”
- `nickname`: ê²Œì„ ë‚´ ì‹ë³„ (ì¤‘ë³µ ë°©ì§€ë¡œ í˜¼ë€ ì œê±°)
- `avatar`: ëœë¤ ì´ëª¨ì§€ë¡œ í”„ë¡œí•„ ì´ë¯¸ì§€ ëŒ€ì²´ (ê°„ë‹¨í•˜ê³  ë¹ ë¦„)
- `joinedAt`: ì…ì¥ ìˆœì„œ ì •ë ¬, í†µê³„ ìˆ˜ì§‘ìš©

**1.4 ë°©ì¥ ìœ„ì„ ë¡œì§**

```typescript
if (player.isHost) {
  const players = Array.from(room.players.values());
  const newHost = players[0];  // ê°€ì¥ ë¨¼ì € ì…ì¥í•œ í”Œë ˆì´ì–´
  newHost.isHost = true;
  room.hostId = newHost.id;
}
```

**ì™œ ì´ ë°©ì‹ì¸ê°€?**
- **ì„ ì…ì„ ì¶œ(FIFO)**: ê°€ì¥ ì˜¤ë˜ ìˆë˜ í”Œë ˆì´ì–´ê°€ ë°©ì¥
- **ìë™í™”**: ìˆ˜ë™ ì§€ì • ë¶ˆí•„ìš”, UX ë‹¨ìˆœí™”
- **ê³µì •ì„±**: ì…ì¥ ìˆœì„œëŠ” ê°ê´€ì  ê¸°ì¤€

**ëŒ€ì•ˆ ê³ ë ¤:**
- íˆ¬í‘œ ë°©ì‹ â†’ ì‹œê°„ ì†Œìš”, ë³µì¡ë„ ì¦ê°€
- ëœë¤ ì„ íƒ â†’ ë¶ˆê³µì •í•˜ë‹¤ëŠ” ì¸ì‹ ê°€ëŠ¥

**1.5 ê²€ì¦ ë¡œì§**

```typescript
joinRoom(code: string, playerId: string, nickname: string) {
  // 1. ë°© ì¡´ì¬ ì—¬ë¶€
  if (!room) return { error: "ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" };

  // 2. ì¤‘ë³µ ì°¸ê°€
  if (room.players.has(playerId)) return { error: "ì´ë¯¸ ë°©ì— ì°¸ê°€í–ˆìŠµë‹ˆë‹¤" };

  // 3. ì¸ì› ì œí•œ
  if (room.players.size >= room.settings.maxPlayers)
    return { error: "ë°©ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤" };

  // 4. ê²Œì„ ì§„í–‰ ì¤‘
  if (room.gameState.isPlaying)
    return { error: "ê²Œì„ì´ ì´ë¯¸ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤" };

  // 5. ë‹‰ë„¤ì„ ì¤‘ë³µ
  const nicknameExists = Array.from(room.players.values())
    .some(p => p.nickname === nickname);
  if (nicknameExists) return { error: "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤" };
}
```

**ê²€ì¦ ìˆœì„œê°€ ì¤‘ìš”í•œ ì´ìœ :**
1. ë°© ì¡´ì¬ ì—¬ë¶€ â†’ ê°€ì¥ ê¸°ë³¸ì ì¸ ê²€ì¦ (ë¹ ë¥¸ ì‹¤íŒ¨)
2. ì¤‘ë³µ ì°¸ê°€ â†’ ì„œë²„ ì˜¤ë¥˜ ê°€ëŠ¥ì„± (ë¬´í•œ ë£¨í”„ ë°©ì§€)
3. ì¸ì› ì œí•œ â†’ ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™
4. ê²Œì„ ì§„í–‰ ì¤‘ â†’ ê²Œì„ ë¬´ê²°ì„± ë³´í˜¸
5. ë‹‰ë„¤ì„ ì¤‘ë³µ â†’ UX ê·œì¹™ (ê°€ì¥ ëŠë¦° ê²€ì¦)

---

### 2. Socket.IO í•¸ë“¤ëŸ¬ (`socket/handlers/room.handler.ts`)

#### 2.1 í•¸ë“¤ëŸ¬ êµ¬ì¡°

```typescript
export function handleCreateRoom(_io: Server, socket: Socket) {
  socket.on(events.CREATE_ROOM, (data, callback) => {
    // ë¡œì§ ì²˜ë¦¬
    callback({ success: true, room });  // ì‘ë‹µ
  });
}
```

**ì™œ ì´ íŒ¨í„´ì¸ê°€?**
- **Callback íŒ¨í„´**: ìš”ì²­-ì‘ë‹µ ëª¨ë¸ (HTTPì™€ ìœ ì‚¬)
- **ì—ëŸ¬ í•¸ë“¤ë§ í†µì¼**: `{ success, error }` í˜•ì‹
- **íƒ€ì… ì•ˆì •ì„±**: TypeScriptë¡œ data íƒ€ì… ëª…ì‹œ

**2.2 ì§ë ¬í™” ì²˜ë¦¬**

```typescript
const roomData = {
  code: room.code,
  hostId: room.hostId,
  players: Array.from(room.players.values()),  // Map â†’ Array
  settings: room.settings,
  gameState: {
    ...room.gameState,
    answers: Array.from(room.gameState.answers.entries()),  // Map â†’ Array
    scores: Array.from(room.gameState.scores.entries()),
    streaks: Array.from(room.gameState.streaks.entries()),
  },
  createdAt: room.createdAt,
};
```

**ì™œ Mapì„ Arrayë¡œ ë³€í™˜í•˜ëŠ”ê°€?**
- **JSON ì§ë ¬í™” ì œí•œ**: Mapì€ JSONìœ¼ë¡œ ì§ë ¬í™”ë˜ì§€ ì•ŠìŒ
  ```javascript
  JSON.stringify(new Map([["a", 1]])) // "{}"  â† ë¹ˆ ê°ì²´!
  ```
- **ë„¤íŠ¸ì›Œí¬ ì „ì†¡**: Socket.IOëŠ” JSON ê¸°ë°˜ ì „ì†¡
- **í´ë¼ì´ì–¸íŠ¸ í˜¸í™˜ì„±**: JavaScript/TypeScriptì—ì„œ Arrayê°€ ë” ë²”ìš©ì 

**ë³€í™˜ ë°©ë²•:**
- `Map<string, Player>` â†’ `Player[]`
- `Map<string, number>` â†’ `[string, number][]`

**2.3 ë¸Œë¡œë“œìºìŠ¤íŒ… ì „ëµ**

```typescript
// ë°©ì˜ ë‹¤ë¥¸ í”Œë ˆì´ì–´ë“¤ì—ê²Œë§Œ ì•Œë¦¼
socket.to(code).emit(events.PLAYER_JOINED, data);

// ë°©ì˜ ëª¨ë“  í”Œë ˆì´ì–´ì—ê²Œ ì•Œë¦¼ (ìì‹  í¬í•¨)
io.to(code).emit(events.SETTINGS_UPDATED, data);
```

**ì°¨ì´ì :**
- `socket.to(room)`: ìì‹ ì„ ì œì™¸í•œ ë°©ì˜ ëª¨ë“  ì‚¬ëŒ
- `io.to(room)`: ë°©ì˜ ëª¨ë“  ì‚¬ëŒ (ìì‹  í¬í•¨)

**ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤:**
- `socket.to()`: ë‚´ê°€ ì…ì¥ â†’ ë‹¤ë¥¸ ì‚¬ëŒë“¤ì—ê²Œ ì•Œë¦¼
- `io.to()`: ì„¤ì • ë³€ê²½ â†’ ëª¨ë‘ì—ê²Œ ë™ê¸°í™”

**2.4 ìë™ ì •ë¦¬ ë©”ì»¤ë‹ˆì¦˜**

```typescript
socket.on("disconnect", () => {
  const rooms = roomService.getAllRooms();

  for (const room of rooms) {
    if (room.players.has(socket.id)) {
      const result = roomService.leaveRoom(room.code, socket.id);

      if (!result.roomDeleted) {
        socket.to(room.code).emit(events.PLAYER_LEFT, {
          playerId: socket.id,
          newHostId: result.newHostId,
        });
      }
      break;  // í•œ ì‚¬ëŒì€ í•œ ë°©ì—ë§Œ ìˆìŒ
    }
  }
});
```

**ì™œ ì´ ë°©ì‹ì¸ê°€?**
- **ìë™ ì •ë¦¬**: ì‚¬ìš©ìê°€ ë¸Œë¼ìš°ì €ë¥¼ ë‹«ì•„ë„ ë°© ìƒíƒœ ìœ ì§€
- **ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€**: ì¢€ë¹„ í”Œë ˆì´ì–´ ì œê±°
- **UX ê°œì„ **: ì—°ê²° ëŠê¸´ ì‚¬ëŒ ìë™ í‡´ì¥

**ì„±ëŠ¥ ê³ ë ¤:**
- `break` ì‚¬ìš©: í•œ ì‚¬ëŒì€ í•œ ë°©ì—ë§Œ (ë¶ˆí•„ìš”í•œ ìˆœíšŒ ì¤‘ë‹¨)
- ì¶”í›„ ê°œì„ : Socketì— roomCode ì €ì¥í•˜ì—¬ O(1) ì¡°íšŒ

---

### 3. Socket.IO ì´ë²¤íŠ¸ ì„¤ê³„ (`socket/events.ts`)

#### 3.1 ì´ë²¤íŠ¸ ëª…ëª… ê·œì¹™

```typescript
// í´ë¼ì´ì–¸íŠ¸ â†’ ì„œë²„ (ëª…ë ¹í˜•)
export const CREATE_ROOM = "create-room";
export const JOIN_ROOM = "join-room";
export const LEAVE_ROOM = "leave-room";

// ì„œë²„ â†’ í´ë¼ì´ì–¸íŠ¸ (ê³¼ê±°í˜• ë˜ëŠ” ì§„í–‰í˜•)
export const PLAYER_JOINED = "player-joined";
export const PLAYER_LEFT = "player-left";
export const SETTINGS_UPDATED = "settings-updated";
```

**ë„¤ì´ë° ì»¨ë²¤ì…˜:**
- **ì¼€ë°¥ ì¼€ì´ìŠ¤(kebab-case)**: ì†Œë¬¸ì + í•˜ì´í”ˆ
- **ëª…ë ¹í˜• vs ê³¼ê±°í˜•**: ë°©í–¥ì„± ëª…í™•íˆ êµ¬ë¶„
- **ì¼ê´€ì„±**: ëª¨ë“  ì´ë²¤íŠ¸ì— ë™ì¼í•œ ê·œì¹™ ì ìš©

**ì™œ ìƒìˆ˜ë¡œ ë¶„ë¦¬í–ˆëŠ”ê°€?**
- **íƒ€ì… ì•ˆì •ì„±**: ì˜¤íƒ€ ë°©ì§€ (ì»´íŒŒì¼ íƒ€ì„ ì²´í¬)
- **ìë™ì™„ì„±**: IDE ì§€ì›
- **ìœ ì§€ë³´ìˆ˜ì„±**: ì´ë²¤íŠ¸ëª… ë³€ê²½ ì‹œ í•œ ê³³ë§Œ ìˆ˜ì •
- **ë¬¸ì„œí™”**: ëª¨ë“  ì´ë²¤íŠ¸ë¥¼ í•œ íŒŒì¼ì—ì„œ í™•ì¸

#### 3.2 ì´ë²¤íŠ¸ í˜ì–´ë§

```
ëª…ë ¹ (Client â†’ Server)     â†’     ì•Œë¦¼ (Server â†’ Clients)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CREATE_ROOM                 â†’     (callbackìœ¼ë¡œ ì‘ë‹µ)
JOIN_ROOM                   â†’     PLAYER_JOINED (ë‹¤ë¥¸ ì‚¬ëŒë“¤)
LEAVE_ROOM                  â†’     PLAYER_LEFT (ë‚¨ì€ ì‚¬ëŒë“¤)
UPDATE_SETTINGS             â†’     SETTINGS_UPDATED (ëª¨ë‘)
START_GAME                  â†’     GAME_STARTED (ëª¨ë‘)
SUBMIT_ANSWER               â†’     ANSWER_SUBMITTED (ë‹¤ë¥¸ ì‚¬ëŒë“¤)
```

**ì„¤ê³„ ì›ì¹™:**
- **ì–‘ë°©í–¥ì„±**: ëª¨ë“  ìƒíƒœ ë³€ê²½ì€ ì•Œë¦¼ìœ¼ë¡œ ë™ê¸°í™”
- **ìµœì†Œ ì§€ì—°**: ì‹¤ì‹œê°„ ë°˜ì˜
- **ì¼ê´€ì„±**: ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ê°€ ë™ì¼í•œ ìƒíƒœ ìœ ì§€

---

## ê¸°ìˆ ì  ê²°ì •ì‚¬í•­

### 1. ì™œ Socket.IOì¸ê°€?

#### ëŒ€ì•ˆ ë¹„êµ

| ê¸°ìˆ  | ì¥ì  | ë‹¨ì  | ê²°ì • |
|------|------|------|------|
| **Socket.IO** | - ìë™ ì¬ì—°ê²°<br>- ë¸Œë¼ìš°ì € í˜¸í™˜ì„±<br>- ë£¸ ê¸°ëŠ¥ ë‚´ì¥<br>- Fallback ì§€ì› | - ì˜¤ë²„í—¤ë“œ (ìˆœìˆ˜ WebSocketë³´ë‹¤ ë¬´ê±°ì›€) | âœ… **ì„ íƒ** |
| **WebSocket** | - ê°€ë³ê³  ë¹ ë¦„<br>- ë„¤ì´í‹°ë¸Œ ì§€ì› | - ì¬ì—°ê²° ì§ì ‘ êµ¬í˜„<br>- ë£¸ ê¸°ëŠ¥ ì—†ìŒ | âŒ |
| **Server-Sent Events** | - ê°„ë‹¨í•œ êµ¬í˜„ | - ë‹¨ë°©í–¥ í†µì‹ <br>- ë¸Œë¼ìš°ì € ì œí•œ | âŒ |
| **Long Polling** | - ë ˆê±°ì‹œ ì§€ì› | - ë¹„íš¨ìœ¨ì <br>- ì§€ì—° ì‹œê°„ | âŒ |

**ê²°ì • ê·¼ê±°:**
- ì‹¤ì‹œê°„ ì–‘ë°©í–¥ í†µì‹  í•„ìˆ˜
- ë£¸ ê¸°ëŠ¥ìœ¼ë¡œ ë¸Œë¡œë“œìºìŠ¤íŒ… ê°„í¸í™”
- ìë™ ì¬ì—°ê²°ë¡œ ì•ˆì •ì„± í™•ë³´
- ê°œë°œ ì†ë„ (ë°”í€´ ì¬ë°œëª… ë¶ˆí•„ìš”)

### 2. ì™œ ë©”ëª¨ë¦¬ ì €ì¥ì†Œ(Map)ì¸ê°€?

#### ë‹¨ê³„ë³„ ì €ì¥ì†Œ ì „ëµ

```
Phase 1 (í˜„ì¬): In-Memory (Map)
    â†“
Phase 2: Redis (ë¶„ì‚° í™˜ê²½ ëŒ€ë¹„)
    â†“
Phase 3: PostgreSQL (ì˜êµ¬ ì €ì¥ + í†µê³„)
```

**í˜„ì¬ ë‹¨ê³„ (Phase 1) ì„ íƒ ì´ìœ :**
- **ë¹ ë¥¸ í”„ë¡œí† íƒ€ì´í•‘**: DB ì„¤ì • ë¶ˆí•„ìš”
- **ë‚®ì€ ë³µì¡ë„**: ì˜ì¡´ì„± ìµœì†Œí™”
- **ì¶©ë¶„í•œ ì„±ëŠ¥**: ìˆ˜ë°± ê°œ ë°© ë™ì‹œ ì²˜ë¦¬ ê°€ëŠ¥
- **ì‰¬ìš´ ë””ë²„ê¹…**: ë©”ëª¨ë¦¬ì—ì„œ ì§ì ‘ í™•ì¸

**í•œê³„ì :**
- ì„œë²„ ì¬ì‹œì‘ ì‹œ ë°ì´í„° ì†ì‹¤
- ìŠ¤ì¼€ì¼ ì•„ì›ƒ ë¶ˆê°€ (ì„œë²„ 1ëŒ€ë§Œ ê°€ëŠ¥)
- ë©”ëª¨ë¦¬ ì œí•œ (ìˆ˜ì²œ ê°œ ë°© ì´ìƒ ì‹œ ë¬¸ì œ)

**ë§ˆì´ê·¸ë ˆì´ì…˜ ê³„íš:**
```typescript
// Phase 2: Redisë¡œ ì „í™˜
class RoomService {
  private redis: RedisClient;

  async getRoom(code: string): Promise<Room | null> {
    const data = await this.redis.get(`room:${code}`);
    return data ? JSON.parse(data) : null;
  }

  async createRoom(...): Promise<Room> {
    const room = { /* ... */ };
    await this.redis.setex(`room:${code}`, 3600, JSON.stringify(room));
    return room;
  }
}
```

### 3. íƒ€ì… ì‹œìŠ¤í…œ ì„¤ê³„

#### 3.1 íƒ€ì… ê³„ì¸µ

```typescript
// ê¸°ë³¸ ì—”í‹°í‹°
interface Player { /* ... */ }
interface Track { /* ... */ }
interface Playlist { /* ... */ }

// ë³µí•© ì—”í‹°í‹°
interface GameState {
  currentTrack: Track | null;  // ê´€ê³„
  answers: Map<string, number>; // ìƒíƒœ
}

interface Room {
  players: Map<string, Player>;  // ì»¬ë ‰ì…˜
  gameState: GameState;          // ì¤‘ì²©
  settings: RoomSettings;        // ì„¤ì •
}
```

**ì„¤ê³„ ì›ì¹™:**
- **ë‹¨ì¼ ì±…ì„**: ê° íƒ€ì…ì€ í•˜ë‚˜ì˜ ê°œë…ë§Œ í‘œí˜„
- **ì¡°í•©ì„±**: ì‘ì€ íƒ€ì…ì„ ì¡°í•©í•˜ì—¬ ë³µì¡í•œ êµ¬ì¡° ìƒì„±
- **ëª…ì‹œì  ê´€ê³„**: `Track | null`ë¡œ ì„ íƒì  ê´€ê³„ í‘œí˜„

#### 3.2 Map vs Object

**ì–¸ì œ Mapì„ ì‚¬ìš©í•˜ëŠ”ê°€?**
```typescript
// âœ… Map ì‚¬ìš©: ë™ì  í‚¤, ë¹ˆë²ˆí•œ ì¶”ê°€/ì‚­ì œ
players: Map<socketId, Player>
answers: Map<playerId, timestamp>

// âœ… Object ì‚¬ìš©: ê³ ì •ëœ êµ¬ì¡°, ì§ë ¬í™” í•„ìš”
settings: { maxPlayers: number, roundInterval: number }
```

**Mapì˜ ì¥ì :**
- ëª¨ë“  íƒ€ì…ì„ í‚¤ë¡œ ì‚¬ìš© ê°€ëŠ¥
- `size` í”„ë¡œí¼í‹° (ObjectëŠ” `Object.keys().length`)
- ìˆœíšŒ ìˆœì„œ ë³´ì¥ (ì‚½ì… ìˆœì„œ)
- ì„±ëŠ¥: ëŒ€ëŸ‰ ë°ì´í„° ì‹œ ë¹ ë¦„

**Objectì˜ ì¥ì :**
- JSON ì§ë ¬í™” ê°€ëŠ¥
- ë¦¬í„°ëŸ´ ë¬¸ë²• ê°„ê²°
- ì •ì  íƒ€ì… ì²´í¬ ì‰¬ì›€

---

## ì‚¬ìš© ê°€ì´ë“œ

### 1. ì„œë²„ ì‹¤í–‰

```bash
# ê°œë°œ ëª¨ë“œ
npm run dev:server

# í”„ë¡œë•ì…˜ ë¹Œë“œ
npm run build:server
```

### 2. í´ë¼ì´ì–¸íŠ¸ ì—°ê²°

```typescript
import { io } from "socket.io-client";

const socket = io("http://localhost:3000");

socket.on("connect", () => {
  console.log("ì„œë²„ ì—°ê²° ì„±ê³µ:", socket.id);
});
```

### 3. ë°© ìƒì„± ì˜ˆì‹œ

```typescript
socket.emit("create-room", {
  nickname: "í”Œë ˆì´ì–´1",
  settings: {
    maxPlayers: 8,
    roundInterval: 30,
    playlistId: "kpop-2000s"
  }
}, (response) => {
  if (response.success) {
    console.log("ë°© ì½”ë“œ:", response.room.code);
    console.log("í”Œë ˆì´ì–´:", response.room.players);

    // ë°© ì½”ë“œë¥¼ UIì— í‘œì‹œ
    displayRoomCode(response.room.code);
  } else {
    console.error("ë°© ìƒì„± ì‹¤íŒ¨:", response.error);
  }
});
```

### 4. ë°© ì°¸ê°€ ì˜ˆì‹œ

```typescript
socket.emit("join-room", {
  code: roomCode,
  nickname: "í”Œë ˆì´ì–´2"
}, (response) => {
  if (response.success) {
    console.log("ì°¸ê°€ ì„±ê³µ!");
    console.log("ë°© ì •ë³´:", response.room);

    // ëŒ€ê¸°ì‹¤ í™”ë©´ìœ¼ë¡œ ì´ë™
    navigateToWaitingRoom(response.room);
  } else {
    alert(response.error);  // ì‚¬ìš©ìì—ê²Œ ì—ëŸ¬ í‘œì‹œ
  }
});
```

### 5. ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ìˆ˜ì‹ 

```typescript
// ìƒˆ í”Œë ˆì´ì–´ ì…ì¥ ì•Œë¦¼
socket.on("player-joined", (data) => {
  console.log(`${data.player.nickname}ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤`);
  console.log("í˜„ì¬ ì¸ì›:", data.playerCount);

  // UI ì—…ë°ì´íŠ¸
  addPlayerToList(data.player);
  updatePlayerCount(data.playerCount);
});

// í”Œë ˆì´ì–´ í‡´ì¥ ì•Œë¦¼
socket.on("player-left", (data) => {
  console.log("í”Œë ˆì´ì–´ í‡´ì¥:", data.playerId);

  // UI ì—…ë°ì´íŠ¸
  removePlayerFromList(data.playerId);

  // ë°©ì¥ì´ ë°”ë€ ê²½ìš°
  if (data.newHostId) {
    console.log("ìƒˆ ë°©ì¥:", data.newHostId);
    updateHostBadge(data.newHostId);
  }
});

// ì„¤ì • ë³€ê²½ ì•Œë¦¼
socket.on("settings-updated", (data) => {
  console.log("ì„¤ì • ë³€ê²½ë¨:", data.settings);

  // UI ì—…ë°ì´íŠ¸
  updateSettingsDisplay(data.settings);
});
```

### 6. ì—ëŸ¬ ì²˜ë¦¬ íŒ¨í„´

```typescript
// ê³µí†µ ì—ëŸ¬ ì²˜ë¦¬ í•¨ìˆ˜
function handleSocketError(response: { success: boolean; error?: string }) {
  if (!response.success) {
    // ì—ëŸ¬ íƒ€ì…ë³„ ì²˜ë¦¬
    switch (response.error) {
      case "ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤":
        alert("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°© ì½”ë“œì…ë‹ˆë‹¤.");
        break;
      case "ë°©ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤":
        alert("ë°©ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ë°©ì„ ì°¾ì•„ë³´ì„¸ìš”.");
        break;
      case "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤":
        alert("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        break;
      default:
        alert(response.error);
    }
    return false;
  }
  return true;
}

// ì‚¬ìš© ì˜ˆì‹œ
socket.emit("join-room", data, (response) => {
  if (handleSocketError(response)) {
    // ì„±ê³µ ì²˜ë¦¬
    navigateToWaitingRoom(response.room);
  }
});
```

### 7. ë””ë²„ê¹…

```typescript
// ì„œë²„ ì‚¬ì´ë“œ ë¡œê¹…
console.log(`âœ… Room created: ${code} by ${nickname}`);
console.log(`ğŸ® ${nickname} joined room ${code}`);
console.log(`ğŸ‘‘ New host: ${newHost.nickname}`);
console.log(`ğŸ—‘ï¸  Room ${code} deleted`);

// í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ëª¨ë‹ˆí„°ë§
socket.onAny((event, ...args) => {
  console.log(`[Socket Event] ${event}:`, args);
});

// ì—°ê²° ìƒíƒœ ì¶”ì 
socket.on("connect", () => console.log("âœ… Connected"));
socket.on("disconnect", () => console.log("âŒ Disconnected"));
socket.on("connect_error", (err) => console.error("Connection error:", err));
```

---

## í–¥í›„ í™•ì¥ ë°©ì•ˆ

### 1. ë°ì´í„° ì˜êµ¬í™” (Phase 2)

#### Redis ë„ì…
```typescript
import { Redis } from "ioredis";

class RoomService {
  private redis: Redis;

  async createRoom(...): Promise<Room> {
    const room = { /* ... */ };

    // Redisì— ì €ì¥ (1ì‹œê°„ TTL)
    await this.redis.setex(
      `room:${room.code}`,
      3600,
      JSON.stringify(room)
    );

    return room;
  }

  async getRoom(code: string): Promise<Room | null> {
    const data = await this.redis.get(`room:${code}`);
    return data ? JSON.parse(data) : null;
  }
}
```

**Redis ì‚¬ìš© ì´ìœ :**
- ë¶„ì‚° í™˜ê²½ ì§€ì› (ì—¬ëŸ¬ ì„œë²„ ê°„ ë°ì´í„° ê³µìœ )
- ë¹ ë¥¸ ì„±ëŠ¥ (ë©”ëª¨ë¦¬ ê¸°ë°˜)
- TTL ìë™ ë§Œë£Œ (ìë™ ì •ë¦¬)
- Pub/Sub ì§€ì› (ì„œë²„ ê°„ ì‹¤ì‹œê°„ ë™ê¸°í™”)

### 2. ìŠ¤ì¼€ì¼ ì•„ì›ƒ (ìˆ˜í‰ í™•ì¥)

```
                 Load Balancer
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚              â”‚              â”‚
    Server 1       Server 2       Server 3
        â”‚              â”‚              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                    Redis
          (ê³µìœ  ë°ì´í„° ì €ì¥ì†Œ)
```

**Socket.IO Adapter ì‚¬ìš©:**
```typescript
import { createAdapter } from "@socket.io/redis-adapter";
import { Redis } from "ioredis";

const pubClient = new Redis();
const subClient = pubClient.duplicate();

io.adapter(createAdapter(pubClient, subClient));
```

**íš¨ê³¼:**
- ì—¬ëŸ¬ ì„œë²„ì—ì„œ ë™ì¼í•œ ë°© ê³µìœ 
- ì„œë²„ Aì˜ í´ë¼ì´ì–¸íŠ¸ â†’ ì„œë²„ Bì˜ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë©”ì‹œì§€ ì „ë‹¬
- ë¡œë“œ ë°¸ëŸ°ì‹± ê°€ëŠ¥

### 3. ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ (Phase 3)

#### PostgreSQL ìŠ¤í‚¤ë§ˆ
```sql
CREATE TABLE rooms (
  code VARCHAR(6) PRIMARY KEY,
  host_id VARCHAR(50) NOT NULL,
  settings JSONB NOT NULL,
  game_state JSONB NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE players (
  id VARCHAR(50) PRIMARY KEY,
  room_code VARCHAR(6) REFERENCES rooms(code),
  nickname VARCHAR(50) NOT NULL,
  avatar VARCHAR(10),
  score INTEGER DEFAULT 0,
  streak INTEGER DEFAULT 0,
  is_host BOOLEAN DEFAULT FALSE,
  joined_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE game_sessions (
  id SERIAL PRIMARY KEY,
  room_code VARCHAR(6) REFERENCES rooms(code),
  playlist_id VARCHAR(50),
  started_at TIMESTAMPTZ,
  ended_at TIMESTAMPTZ,
  winner_id VARCHAR(50)
);
```

**ì‚¬ìš© ëª©ì :**
- ê²Œì„ íˆìŠ¤í† ë¦¬ ì €ì¥
- í†µê³„ ë¶„ì„ (ì¸ê¸° í”Œë ˆì´ë¦¬ìŠ¤íŠ¸, í‰ê·  ê²Œì„ ì‹œê°„ ë“±)
- ë¦¬ë”ë³´ë“œ ê¸°ëŠ¥
- ì‚¬ìš©ì í”„ë¡œí•„ (ì„ íƒì )

### 4. ë³´ì•ˆ ê°•í™”

#### 4.1 Rate Limiting
```typescript
import rateLimit from "express-rate-limit";

const createRoomLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15ë¶„
  max: 5, // ìµœëŒ€ 5ê°œ ë°© ìƒì„±
  message: "ë„ˆë¬´ ë§ì€ ë°©ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
});

app.post("/api/rooms", createRoomLimiter, ...);
```

#### 4.2 ë°© ì½”ë“œ ê²€ì¦
```typescript
function isValidRoomCode(code: string): boolean {
  // 6ìë¦¬ ì˜ë¬¸ì ëŒ€ë¬¸ìë§Œ í—ˆìš©
  return /^[A-Z]{6}$/.test(code);
}
```

#### 4.3 ë‹‰ë„¤ì„ í•„í„°ë§
```typescript
const BANNED_WORDS = ["ìš•ì„¤1", "ìš•ì„¤2", ...];

function isValidNickname(nickname: string): boolean {
  if (nickname.length < 2 || nickname.length > 10) return false;
  if (BANNED_WORDS.some(word => nickname.includes(word))) return false;
  return true;
}
```

### 5. ëª¨ë‹ˆí„°ë§ ë° ë¶„ì„

#### 5.1 ë©”íŠ¸ë¦­ ìˆ˜ì§‘
```typescript
import StatsD from "node-statsd";

const stats = new StatsD();

// ë°© ìƒì„± ì¹´ìš´íŠ¸
stats.increment("rooms.created");

// í˜„ì¬ í™œì„± ë°© ìˆ˜
stats.gauge("rooms.active", roomService.getAllRooms().length);

// í‰ê·  í”Œë ˆì´ì–´ ìˆ˜
stats.gauge("players.average", totalPlayers / totalRooms);
```

#### 5.2 ë¡œê¹…
```typescript
import winston from "winston";

const logger = winston.createLogger({
  level: "info",
  format: winston.format.json(),
  transports: [
    new winston.transports.File({ filename: "error.log", level: "error" }),
    new winston.transports.File({ filename: "combined.log" })
  ]
});

logger.info("Room created", {
  roomCode: code,
  hostId: hostId,
  timestamp: Date.now()
});
```

### 6. ì¶”ê°€ ê¸°ëŠ¥ ì•„ì´ë””ì–´

#### 6.1 ë°© ì„¤ì • í™•ì¥
```typescript
interface RoomSettings {
  maxPlayers: number;
  roundInterval: number;
  playlistId: string;

  // ì¶”ê°€ ì„¤ì •
  difficulty: "easy" | "medium" | "hard";  // ë‚œì´ë„
  allowHints: boolean;                     // íŒíŠ¸ í—ˆìš© ì—¬ë¶€
  privateRoom: boolean;                    // ë¹„ê³µê°œ ë°© ì—¬ë¶€
  password?: string;                       // ë¹„ë°€ë²ˆí˜¸ (ì„ íƒì )
}
```

#### 6.2 ì¹œêµ¬ ì´ˆëŒ€ ì‹œìŠ¤í…œ
```typescript
socket.emit("invite-friend", {
  roomCode: "ABC123",
  friendId: "friend-socket-id"
});

// ì¹œêµ¬ê°€ ì•Œë¦¼ ë°›ìŒ
socket.on("room-invitation", (data) => {
  showInvitationPopup(data.roomCode, data.fromNickname);
});
```

#### 6.3 ì±„íŒ… ê¸°ëŠ¥
```typescript
socket.emit("send-message", {
  roomCode: "ABC123",
  message: "ì•ˆë…•í•˜ì„¸ìš”!"
});

socket.on("new-message", (data) => {
  addChatMessage(data.nickname, data.message, data.timestamp);
});
```

#### 6.4 ê´€ì „ ëª¨ë“œ
```typescript
// ê²Œì„ ì¤‘ì¸ ë°©ì„ ê´€ì „ë§Œ ê°€ëŠ¥
socket.emit("spectate-room", {
  code: "ABC123"
});

// ê´€ì „ìëŠ” ê²Œì„ ìƒíƒœë§Œ ë°›ê³  ì°¸ì—¬ëŠ” ë¶ˆê°€
socket.on("game-update", (data) => {
  updateSpectatorView(data);
});
```

---

## ì„±ëŠ¥ ìµœì í™”

### 1. í˜„ì¬ ì„±ëŠ¥ íŠ¹ì„±

**ì‹œê°„ ë³µì¡ë„:**
```typescript
createRoom()      â†’ O(1)  // Map.set()
getRoom()         â†’ O(1)  // Map.get()
joinRoom()        â†’ O(n)  // ë‹‰ë„¤ì„ ì¤‘ë³µ ì²´í¬ (n = í”Œë ˆì´ì–´ ìˆ˜)
leaveRoom()       â†’ O(1)  // Map.delete()
getAllRooms()     â†’ O(m)  // m = ë°© ê°œìˆ˜
```

**ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰:**
```
1ê°œ Room â‰ˆ 1KB (ì„¤ì • + ë©”íƒ€ë°ì´í„°)
1ëª… Player â‰ˆ 200B
8ëª… ë°© 1ê°œ â‰ˆ 1KB + 8 * 200B = 2.6KB

1000ê°œ ë°©, í‰ê·  4ëª… â‰ˆ 1000 * 1.8KB = 1.8MB
```

**í˜„ì¬ ì„±ëŠ¥ìœ¼ë¡œ ì²˜ë¦¬ ê°€ëŠ¥í•œ ê·œëª¨:**
- ë™ì‹œ ë°©: ~10,000ê°œ
- ë™ì‹œ í”Œë ˆì´ì–´: ~40,000ëª…
- ë©”ëª¨ë¦¬: ~20MB

### 2. ë³‘ëª© ì§€ì  ë° í•´ê²°

#### ë³‘ëª© 1: ë‹‰ë„¤ì„ ì¤‘ë³µ ì²´í¬
```typescript
// í˜„ì¬ (O(n))
const nicknameExists = Array.from(room.players.values())
  .some(p => p.nickname === nickname);

// ìµœì í™” (O(1))
private nicknameIndex: Map<string, Set<string>>;  // roomCode â†’ Set<nickname>

function isNicknameUsed(roomCode: string, nickname: string): boolean {
  return this.nicknameIndex.get(roomCode)?.has(nickname) ?? false;
}
```

#### ë³‘ëª© 2: ì—°ê²° í•´ì œ ì‹œ ë°© ì°¾ê¸°
```typescript
// í˜„ì¬ (O(m * n))
for (const room of rooms) {
  if (room.players.has(socket.id)) { ... }
}

// ìµœì í™” (O(1))
private playerRoomIndex: Map<string, string>;  // socketId â†’ roomCode

socket.on("disconnect", () => {
  const roomCode = this.playerRoomIndex.get(socket.id);
  if (roomCode) {
    this.leaveRoom(roomCode, socket.id);
  }
});
```

### 3. ìºì‹± ì „ëµ

```typescript
class RoomService {
  private statsCache: { data: any; expiry: number } | null = null;

  getStats() {
    const now = Date.now();

    // ìºì‹œê°€ ìœ íš¨í•˜ë©´ ë°˜í™˜
    if (this.statsCache && this.statsCache.expiry > now) {
      return this.statsCache.data;
    }

    // ìºì‹œ ê°±ì‹  (10ì´ˆ TTL)
    const stats = {
      totalRooms: this.rooms.size,
      totalPlayers: Array.from(this.rooms.values())
        .reduce((sum, room) => sum + room.players.size, 0)
    };

    this.statsCache = {
      data: stats,
      expiry: now + 10000
    };

    return stats;
  }
}
```

---

## í…ŒìŠ¤íŠ¸ ì „ëµ

### 1. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (Jest)

```typescript
import { RoomService } from "./room";

describe("RoomService", () => {
  let roomService: RoomService;

  beforeEach(() => {
    roomService = new RoomService();
  });

  describe("createRoom", () => {
    it("should create room with unique code", () => {
      const room1 = roomService.createRoom("host1", "Player1", settings);
      const room2 = roomService.createRoom("host2", "Player2", settings);

      expect(room1.code).not.toBe(room2.code);
      expect(room1.code).toHaveLength(6);
    });

    it("should set creator as host", () => {
      const room = roomService.createRoom("host1", "Player1", settings);
      const host = room.players.get("host1");

      expect(host?.isHost).toBe(true);
      expect(room.hostId).toBe("host1");
    });
  });

  describe("joinRoom", () => {
    it("should reject duplicate nickname", () => {
      const room = roomService.createRoom("host1", "Player1", settings);
      const result = roomService.joinRoom(room.code, "player2", "Player1");

      expect(result.success).toBe(false);
      expect(result.error).toBe("ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤");
    });

    it("should reject when room is full", () => {
      const settings = { maxPlayers: 2, roundInterval: 30, playlistId: "test" };
      const room = roomService.createRoom("host1", "Player1", settings);

      roomService.joinRoom(room.code, "player2", "Player2");
      const result = roomService.joinRoom(room.code, "player3", "Player3");

      expect(result.success).toBe(false);
      expect(result.error).toBe("ë°©ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤");
    });
  });

  describe("leaveRoom", () => {
    it("should transfer host when host leaves", () => {
      const room = roomService.createRoom("host1", "Player1", settings);
      roomService.joinRoom(room.code, "player2", "Player2");

      const result = roomService.leaveRoom(room.code, "host1");

      expect(result.newHostId).toBe("player2");
      expect(room.hostId).toBe("player2");
    });

    it("should delete room when empty", () => {
      const room = roomService.createRoom("host1", "Player1", settings);
      const result = roomService.leaveRoom(room.code, "host1");

      expect(result.roomDeleted).toBe(true);
      expect(roomService.getRoom(room.code)).toBeUndefined();
    });
  });
});
```

### 2. í†µí•© í…ŒìŠ¤íŠ¸ (Socket.IO)

```typescript
import { io as Client } from "socket.io-client";
import { createServer } from "./index";

describe("Socket.IO Integration", () => {
  let server: any;
  let clientSocket: any;

  beforeAll((done) => {
    server = createServer();
    server.listen(3001, done);
  });

  afterAll(() => {
    server.close();
  });

  beforeEach((done) => {
    clientSocket = Client("http://localhost:3001");
    clientSocket.on("connect", done);
  });

  afterEach(() => {
    clientSocket.close();
  });

  test("should create and join room", (done) => {
    clientSocket.emit("create-room", {
      nickname: "Host",
      settings: { maxPlayers: 8, roundInterval: 30, playlistId: "test" }
    }, (response) => {
      expect(response.success).toBe(true);
      expect(response.room.code).toBeDefined();

      const roomCode = response.room.code;

      // ë‘ ë²ˆì§¸ í´ë¼ì´ì–¸íŠ¸ ì—°ê²°
      const client2 = Client("http://localhost:3001");
      client2.on("connect", () => {
        client2.emit("join-room", {
          code: roomCode,
          nickname: "Player2"
        }, (response2) => {
          expect(response2.success).toBe(true);
          expect(response2.room.players).toHaveLength(2);

          client2.close();
          done();
        });
      });
    });
  });

  test("should broadcast player-joined event", (done) => {
    clientSocket.emit("create-room", {
      nickname: "Host",
      settings: { maxPlayers: 8, roundInterval: 30, playlistId: "test" }
    }, (response) => {
      const roomCode = response.room.code;

      // player-joined ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
      clientSocket.on("player-joined", (data) => {
        expect(data.player.nickname).toBe("Player2");
        expect(data.playerCount).toBe(2);
        done();
      });

      // ë‘ ë²ˆì§¸ í´ë¼ì´ì–¸íŠ¸ê°€ ì…ì¥
      const client2 = Client("http://localhost:3001");
      client2.on("connect", () => {
        client2.emit("join-room", {
          code: roomCode,
          nickname: "Player2"
        }, () => {
          client2.close();
        });
      });
    });
  });
});
```

### 3. ë¶€í•˜ í…ŒìŠ¤íŠ¸ (Artillery)

```yaml
# load-test.yml
config:
  target: "http://localhost:3000"
  socketio:
    transports: ["websocket"]
  phases:
    - duration: 60
      arrivalRate: 10  # ì´ˆë‹¹ 10ëª… ì—°ê²°
      name: "Warm up"
    - duration: 120
      arrivalRate: 50  # ì´ˆë‹¹ 50ëª… ì—°ê²°
      name: "Peak load"

scenarios:
  - name: "Create and join rooms"
    engine: socketio
    flow:
      - emit:
          channel: "create-room"
          data:
            nickname: "Player{{ $randomNumber() }}"
            settings:
              maxPlayers: 8
              roundInterval: 30
              playlistId: "test-playlist"
      - think: 5
      - emit:
          channel: "leave-room"
          data:
            code: "{{ roomCode }}"
```

**ì‹¤í–‰:**
```bash
artillery run load-test.yml
```

---

## íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ë¬¸ì œ 1: Map ì§ë ¬í™” ì—ëŸ¬

**ì¦ìƒ:**
```javascript
// í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë°›ì€ ë°ì´í„°
{ players: {} }  // ë¹ˆ ê°ì²´!
```

**ì›ì¸:**
```javascript
JSON.stringify(new Map([["a", 1]])) // "{}"
```

**í•´ê²°:**
```typescript
// Mapì„ Arrayë¡œ ë³€í™˜
players: Array.from(room.players.values())
```

### ë¬¸ì œ 2: ì—°ê²° í•´ì œ í›„ ì¢€ë¹„ í”Œë ˆì´ì–´

**ì¦ìƒ:**
- í”Œë ˆì´ì–´ê°€ ë¸Œë¼ìš°ì €ë¥¼ ë‹«ì•˜ëŠ”ë° ë°©ì— ë‚¨ì•„ìˆìŒ

**ì›ì¸:**
- `disconnect` ì´ë²¤íŠ¸ ì²˜ë¦¬ ëˆ„ë½

**í•´ê²°:**
```typescript
socket.on("disconnect", () => {
  // ìë™ìœ¼ë¡œ ë°©ì—ì„œ ì œê±°
  roomService.leaveRoom(roomCode, socket.id);
});
```

### ë¬¸ì œ 3: ë°©ì¥ í‡´ì¥ ì‹œ ë°© ë§ˆë¹„

**ì¦ìƒ:**
- ë°©ì¥ì´ ë‚˜ê°€ë©´ ì•„ë¬´ë„ ê²Œì„ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŒ

**ì›ì¸:**
- ë°©ì¥ ìœ„ì„ ë¡œì§ ëˆ„ë½

**í•´ê²°:**
```typescript
if (player.isHost) {
  const newHost = players[0];  // ë‹¤ìŒ í”Œë ˆì´ì–´ë¥¼ ë°©ì¥ìœ¼ë¡œ
  newHost.isHost = true;
}
```

---

## ê²°ë¡ 

### ë‹¬ì„±í•œ ëª©í‘œ

1. âœ… **ì•ˆì •ì ì¸ ì‹¤ì‹œê°„ í†µì‹ **: Socket.IOë¡œ ì–‘ë°©í–¥ í†µì‹  êµ¬í˜„
2. âœ… **í™•ì¥ ê°€ëŠ¥í•œ êµ¬ì¡°**: ì„œë¹„ìŠ¤ ë ˆì´ì–´ ë¶„ë¦¬ë¡œ ì¶”í›„ DB ì „í™˜ ìš©ì´
3. âœ… **íƒ€ì… ì•ˆì •ì„±**: TypeScriptë¡œ ì»´íŒŒì¼ íƒ€ì„ ì—ëŸ¬ ë°©ì§€
4. âœ… **ì‚¬ìš©ì ê²½í—˜**: ìë™ ì •ë¦¬, ì—ëŸ¬ ì²˜ë¦¬ë¡œ ì•ˆì •ì„± í™•ë³´

### í•™ìŠµí•œ ë‚´ìš©

1. **Socket.IO í•µì‹¬ ê°œë…**
   - ë£¸(Room) ê¸°ëŠ¥ìœ¼ë¡œ ê·¸ë£¹ í†µì‹ 
   - `socket.to()` vs `io.to()` ì°¨ì´
   - ìë™ ì¬ì—°ê²° ë©”ì»¤ë‹ˆì¦˜

2. **ì‹¤ì‹œê°„ ì‹œìŠ¤í…œ ì„¤ê³„**
   - ìƒíƒœ ë™ê¸°í™” ì „ëµ
   - ë¸Œë¡œë“œìºìŠ¤íŒ… íŒ¨í„´
   - ìë™ ì •ë¦¬ ë©”ì»¤ë‹ˆì¦˜

3. **íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ í™œìš©**
   - Map vs Object ì„ íƒ ê¸°ì¤€
   - ì§ë ¬í™” ì´ìŠˆ í•´ê²°
   - íƒ€ì… ì•ˆì •ì„± í™•ë³´

### ë‹¤ìŒ ë‹¨ê³„

1. **ê²Œì„ ë¡œì§ êµ¬í˜„** (`game.ts`)
   - ë¼ìš´ë“œ ê´€ë¦¬
   - ì •ë‹µ ì±„ì 
   - ì ìˆ˜ ê³„ì‚°

2. **ì±„íŒ… ê¸°ëŠ¥** (`chat.handler.ts`)
   - ì‹¤ì‹œê°„ ë©”ì‹œì§€ ì „ì†¡
   - ìš•ì„¤ í•„í„°ë§
   - ì´ëª¨ì§€ ì§€ì›

3. **í”„ë¡ íŠ¸ì—”ë“œ UI**
   - ë°© ìƒì„±/ì…ì¥ í™”ë©´
   - ëŒ€ê¸°ì‹¤ (í”Œë ˆì´ì–´ ëª©ë¡)
   - ê²Œì„ í™”ë©´

4. **ë°ì´í„° ì˜êµ¬í™”**
   - Redis ë„ì…
   - ê²Œì„ íˆìŠ¤í† ë¦¬ ì €ì¥
   - ë¦¬ë”ë³´ë“œ ê¸°ëŠ¥

---

**ì‘ì„±ì**: Claude (AI Assistant)
**ê²€í† **: í•„ìš” ì‹œ ì½”ë“œ ë¦¬ë·° ë° í…ŒìŠ¤íŠ¸ ì§„í–‰
**ë²„ì „**: 1.0.0
**ìµœì¢… ìˆ˜ì •ì¼**: 2025-10-21
