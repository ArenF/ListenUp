# ğŸ® ê²Œì„ ì‹œìŠ¤í…œ êµ¬í˜„ ë³´ê³ ì„œ

**ì‘ì„±ì¼**: 2025-10-30
**í”„ë¡œì íŠ¸**: ListenUp! - ì‹¤ì‹œê°„ ìŒì•… ë§ì¶”ê¸° ê²Œì„
**ì‘ì—… ë²”ìœ„**: GameService í´ë˜ìŠ¤ êµ¬í˜„ ë° í…ŒìŠ¤íŠ¸

---

## ğŸ“‹ ëª©ì°¨

1. [ì‘ì—… ê°œìš”](#ì‘ì—…-ê°œìš”)
2. [ì•„í‚¤í…ì²˜ ì„¤ê³„](#ì•„í‚¤í…ì²˜-ì„¤ê³„)
3. [êµ¬í˜„ ìƒì„¸](#êµ¬í˜„-ìƒì„¸)
4. [í…ŒìŠ¤íŠ¸ ì „ëµ](#í…ŒìŠ¤íŠ¸-ì „ëµ)
5. [í•µì‹¬ ì•Œê³ ë¦¬ì¦˜](#í•µì‹¬-ì•Œê³ ë¦¬ì¦˜)
6. [ì‚¬ìš© ê°€ì´ë“œ](#ì‚¬ìš©-ê°€ì´ë“œ)
7. [í–¥í›„ í™•ì¥ ë°©ì•ˆ](#í–¥í›„-í™•ì¥-ë°©ì•ˆ)

---

## ì‘ì—… ê°œìš”

### ëª©í‘œ
ìŒì•… ë§ì¶”ê¸° ê²Œì„ì˜ í•µì‹¬ ë¡œì§ì„ ë‹´ë‹¹í•˜ëŠ” GameServiceë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤. ê²Œì„ ì‹œì‘ë¶€í„° ì¢…ë£Œê¹Œì§€ì˜ ì „ì²´ íë¦„ì„ ê´€ë¦¬í•˜ê³ , ì •ë‹µ ì±„ì  ë° ì ìˆ˜ ê³„ì‚°ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

### ì™„ë£Œëœ ì‘ì—…
1. âœ… ê²Œì„ ê´€ë ¨ íƒ€ì… ì •ì˜ ì¶”ê°€
2. âœ… GameService í´ë˜ìŠ¤ êµ¬í˜„
3. âœ… ì •ë‹µ ì²´í¬ ì•Œê³ ë¦¬ì¦˜ (Levenshtein distance ê¸°ë°˜)
4. âœ… ì ìˆ˜ ê³„ì‚° ì‹œìŠ¤í…œ (ì‹œê°„ ë³´ë„ˆìŠ¤ + ìŠ¤íŠ¸ë¦­ ë³´ë„ˆìŠ¤)
5. âœ… í¬ê´„ì ì¸ í…ŒìŠ¤íŠ¸ ì‘ì„± (36ê°œ í…ŒìŠ¤íŠ¸ ëª¨ë‘ í†µê³¼)
6. âœ… Vitest í…ŒìŠ¤íŠ¸ í™˜ê²½ êµ¬ì¶•

### ì£¼ìš” ê¸°ëŠ¥
- ê²Œì„ ì‹œì‘/ì¢…ë£Œ ê´€ë¦¬
- ë¼ìš´ë“œ ì§„í–‰ ë° íŠ¸ë™ ì„ íƒ
- ì •ë‹µ ì œì¶œ ë° ì±„ì 
- ì ìˆ˜ ê³„ì‚° ë° ìˆœìœ„ ê²°ì •
- ê²Œì„ íˆìŠ¤í† ë¦¬ ì €ì¥

---

## ì•„í‚¤í…ì²˜ ì„¤ê³„

### 1. ì „ì²´ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Game Flow                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. startGame()                                             â”‚
â”‚     â”œâ”€ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ë¡œë“œ                                      â”‚
â”‚     â”œâ”€ ê²Œì„ ìƒíƒœ ì´ˆê¸°í™”                                       â”‚
â”‚     â””â”€ í”Œë ˆì´ì–´ ì ìˆ˜ ì´ˆê¸°í™”                                   â”‚
â”‚                                                             â”‚
â”‚  2. startRound()                                            â”‚
â”‚     â”œâ”€ ë¼ìš´ë“œ ë²ˆí˜¸ ì¦ê°€                                       â”‚
â”‚     â”œâ”€ ëœë¤ íŠ¸ë™ ì„ íƒ                                         â”‚
â”‚     â””â”€ ë¼ìš´ë“œ ì‹œì‘ ì‹œê°„ ê¸°ë¡                                  â”‚
â”‚                                                             â”‚
â”‚  3. submitAnswer() (ë°˜ë³µ)                                   â”‚
â”‚     â”œâ”€ ì •ë‹µ ì²´í¬ (ìœ ì‚¬ë„ ì•Œê³ ë¦¬ì¦˜)                            â”‚
â”‚     â”œâ”€ ì ìˆ˜ ê³„ì‚° (ê¸°ë³¸ + ì‹œê°„ ë³´ë„ˆìŠ¤)                         â”‚
â”‚     â”œâ”€ ìŠ¤íŠ¸ë¦­ ì—…ë°ì´íŠ¸                                        â”‚
â”‚     â””â”€ ëˆ„ì  ì ìˆ˜ ê°±ì‹                                          â”‚
â”‚                                                             â”‚
â”‚  4. endRound()                                              â”‚
â”‚     â”œâ”€ ë‹µì•ˆ ìˆ˜ì§‘ ë° ì§‘ê³„                                      â”‚
â”‚     â”œâ”€ ë¼ìš´ë“œ ê²°ê³¼ ìƒì„±                                       â”‚
â”‚     â””â”€ ë‹¤ìŒ ë¼ìš´ë“œ ì¤€ë¹„                                       â”‚
â”‚                                                             â”‚
â”‚  5. endGame()                                               â”‚
â”‚     â”œâ”€ ìµœì¢… ì ìˆ˜ ì§‘ê³„                                         â”‚
â”‚     â”œâ”€ ìš°ìŠ¹ì ê²°ì •                                           â”‚
â”‚     â”œâ”€ ê²Œì„ íˆìŠ¤í† ë¦¬ ì €ì¥                                     â”‚
â”‚     â””â”€ ê²Œì„ ìƒíƒœ ì´ˆê¸°í™”                                       â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. íƒ€ì… ê³„ì¸µ êµ¬ì¡°

```typescript
// ê¸°ë³¸ íƒ€ì… (ê¸°ì¡´)
Player
Track
Playlist
GameState
Room

// ê²Œì„ ê´€ë ¨ íƒ€ì… (ì‹ ê·œ ì¶”ê°€)
â”œâ”€ AnswerSubmission      // ë‹µì•ˆ ì œì¶œ ì •ë³´
â”œâ”€ RoundResult           // ë¼ìš´ë“œ ê²°ê³¼
â”œâ”€ GameResult            // ê²Œì„ ìµœì¢… ê²°ê³¼
â””â”€ AnswerCheckResult     // ì •ë‹µ ì²´í¬ ê²°ê³¼
```

### 3. ë°ì´í„° íë¦„

```
Room.gameState (GameState)
    â”‚
    â”œâ”€ isPlaying: boolean
    â”œâ”€ currentRound: number
    â”œâ”€ totalRounds: number
    â”œâ”€ currentTrack: Track | null
    â”œâ”€ roundStartTime: number
    â”œâ”€ answers: Map<playerId, timestamp>
    â”œâ”€ scores: Map<playerId, score>
    â””â”€ streaks: Map<playerId, streak>
```

---

## êµ¬í˜„ ìƒì„¸

### 1. íƒ€ì… ì •ì˜ (types/index.ts)

#### 1.1 AnswerSubmission

```typescript
export interface AnswerSubmission {
  playerId: string;
  answer: string;
  timestamp: number;          // ì œì¶œ ì‹œê°„ (ms)
  isCorrect: boolean;
  score: number;              // í•´ë‹¹ ë¼ìš´ë“œì—ì„œ íšë“í•œ ì ìˆ˜
}
```

**ì„¤ê³„ ê·¼ê±°:**
- `timestamp`: ì œì¶œ ì‹œê°„ì„ ê¸°ë¡í•˜ì—¬ ì ìˆ˜ ê³„ì‚°ì— í™œìš©
- `isCorrect`: ì •ë‹µ ì—¬ë¶€ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì €ì¥
- `score`: ë¼ìš´ë“œë³„ ì ìˆ˜ë¥¼ ê¸°ë¡í•˜ì—¬ ì¶”í›„ ë¶„ì„ ê°€ëŠ¥

#### 1.2 RoundResult

```typescript
export interface RoundResult {
  roundNumber: number;
  track: Track;                           // ì •ë‹µ íŠ¸ë™ ì •ë³´
  answers: AnswerSubmission[];            // ëª¨ë“  í”Œë ˆì´ì–´ì˜ ë‹µì•ˆ
  correctAnswers: AnswerSubmission[];     // ì •ë‹µìë“¤
  scores: Map<string, number>;            // í˜„ì¬ê¹Œì§€ ëˆ„ì  ì ìˆ˜
  streaks: Map<string, number>;           // ì—°ì† ì •ë‹µ ìŠ¤íŠ¸ë¦­
}
```

**ì„¤ê³„ ê·¼ê±°:**
- ë¼ìš´ë“œë³„ ëª¨ë“  ì •ë³´ë¥¼ ë³´ì¡´í•˜ì—¬ ê²Œì„ ë¦¬í”Œë ˆì´ ê°€ëŠ¥
- `correctAnswers`ë¥¼ ë³„ë„ë¡œ ì €ì¥í•˜ì—¬ ë¹ ë¥¸ ì¡°íšŒ
- Map íƒ€ì…ìœ¼ë¡œ O(1) ì¡°íšŒ ì„±ëŠ¥ ë³´ì¥

#### 1.3 GameResult

```typescript
export interface GameResult {
  roomCode: string;
  totalRounds: number;
  finalScores: Array<{
    playerId: string;
    nickname: string;
    score: number;
    correctAnswers: number;
    maxStreak: number;
  }>;
  winner: {
    playerId: string;
    nickname: string;
    score: number;
  } | null;
  playedAt: number;
}
```

**ì„¤ê³„ ê·¼ê±°:**
- ê²Œì„ íˆìŠ¤í† ë¦¬ ì €ì¥ì„ ìœ„í•œ ì™„ì „í•œ ì •ë³´ í¬í•¨
- `finalScores`ë¥¼ ë°°ì—´ë¡œ ì €ì¥í•˜ì—¬ ìˆœìœ„ ì •ë³´ ìœ ì§€
- `playedAt`ìœ¼ë¡œ ê²Œì„ ì‹œê°„ ê¸°ë¡ (í†µê³„/ë¶„ì„ìš©)

#### 1.4 AnswerCheckResult

```typescript
export interface AnswerCheckResult {
  isCorrect: boolean;
  score: number;
  message: string;
  streak: number;
}
```

**ì„¤ê³„ ê·¼ê±°:**
- í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì¦‰ê°ì ì¸ í”¼ë“œë°± ì œê³µ
- `message`ë¡œ ì‚¬ìš©ì ì¹œí™”ì ì¸ ë©”ì‹œì§€ ì „ë‹¬
- ì ìˆ˜ì™€ ìŠ¤íŠ¸ë¦­ì„ í•¨ê»˜ ë°˜í™˜í•˜ì—¬ UI ì—…ë°ì´íŠ¸ ê°„ì†Œí™”

---

### 2. GameService í´ë˜ìŠ¤

#### 2.1 í´ë˜ìŠ¤ êµ¬ì¡°

```typescript
export class GameService {
  // í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì €ì¥ì†Œ (ì¶”í›„ DBë‚˜ íŒŒì¼ì—ì„œ ë¡œë“œ)
  private playlists: Map<string, Playlist>;

  // ê²Œì„ íˆìŠ¤í† ë¦¬ ì €ì¥ (ì„ íƒì )
  private gameHistory: GameResult[];

  constructor() {
    this.playlists = new Map();
    this.gameHistory = [];
    this.initializePlaylists();
  }
}
```

**ì„¤ê³„ ì›ì¹™:**
- **ì‹±ê¸€í†¤ íŒ¨í„´**: íŒŒì¼ ë§ˆì§€ë§‰ì— `export const gameService = new GameService()` ì œê³µ
- **ë©”ëª¨ë¦¬ ì €ì¥**: í”„ë¡œí† íƒ€ì… ë‹¨ê³„ì—ì„œëŠ” ë©”ëª¨ë¦¬ì— ì €ì¥, ì¶”í›„ DBë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ ìš©ì´
- **íˆìŠ¤í† ë¦¬ ê´€ë¦¬**: ê²Œì„ ê²°ê³¼ë¥¼ ì €ì¥í•˜ì—¬ í†µê³„ ë° ë¦¬ë”ë³´ë“œ ê¸°ëŠ¥ ì œê³µ

#### 2.2 ê²Œì„ ì‹œì‘ (startGame)

```typescript
startGame(room: Room): { success: boolean; error?: string; gameState?: GameState }
```

**êµ¬í˜„ ë¡œì§:**
```typescript
// 1. ê²€ì¦
if (room.gameState.isPlaying) return { success: false, error: "ì´ë¯¸ ê²Œì„ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤" };
if (room.players.size < 1) return { success: false, error: "ìµœì†Œ 1ëª…ì˜ í”Œë ˆì´ì–´ê°€ í•„ìš”í•©ë‹ˆë‹¤" };

// 2. í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ë¡œë“œ
const playlist = this.getPlaylist(room.settings.playlistId);
if (!playlist) return { success: false, error: "í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" };

// 3. ê²Œì„ ìƒíƒœ ì´ˆê¸°í™”
room.gameState.isPlaying = true;
room.gameState.currentRound = 0;
room.gameState.totalRounds = playlist.roundCount;
room.gameState.answers = new Map();
room.gameState.scores = new Map();
room.gameState.streaks = new Map();

// 4. ëª¨ë“  í”Œë ˆì´ì–´ ì ìˆ˜ ì´ˆê¸°í™”
for (const [playerId] of room.players) {
  room.gameState.scores.set(playerId, 0);
  room.gameState.streaks.set(playerId, 0);
}

return { success: true, gameState: room.gameState };
```

**ê²€ì¦ ìˆœì„œì˜ ì¤‘ìš”ì„±:**
1. ê²Œì„ ìƒíƒœ ì²´í¬ (ë¹ ë¥¸ ì‹¤íŒ¨)
2. í”Œë ˆì´ì–´ ìˆ˜ ì²´í¬ (ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™)
3. í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì¡´ì¬ ì—¬ë¶€ (ë¦¬ì†ŒìŠ¤ ê²€ì¦)

#### 2.3 ë¼ìš´ë“œ ì‹œì‘ (startRound)

```typescript
startRound(room: Room, tracks: Track[]): {
  success: boolean;
  error?: string;
  track?: Track;
  roundNumber?: number
}
```

**êµ¬í˜„ ë¡œì§:**
```typescript
// 1. ê²€ì¦
if (!room.gameState.isPlaying) return { success: false, error: "ê²Œì„ì´ ì‹œì‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤" };
if (room.gameState.currentRound >= room.gameState.totalRounds) {
  return { success: false, error: "ëª¨ë“  ë¼ìš´ë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤" };
}
if (!tracks || tracks.length === 0) return { success: false, error: "ì¬ìƒí•  íŠ¸ë™ì´ ì—†ìŠµë‹ˆë‹¤" };

// 2. ë¼ìš´ë“œ ì§„í–‰
room.gameState.currentRound += 1;
room.gameState.answers.clear();  // ì´ì „ ë¼ìš´ë“œ ë‹µì•ˆ ì´ˆê¸°í™”

// 3. ëœë¤ íŠ¸ë™ ì„ íƒ
const randomIndex = Math.floor(Math.random() * tracks.length);
const selectedTrack = tracks[randomIndex];

room.gameState.currentTrack = selectedTrack;
room.gameState.roundStartTime = Date.now();

return { success: true, track: selectedTrack, roundNumber: room.gameState.currentRound };
```

**ê°œì„  í¬ì¸íŠ¸ (í–¥í›„):**
- ì¤‘ë³µ íŠ¸ë™ ë°©ì§€ ë¡œì§ ì¶”ê°€
- ë‚œì´ë„ë³„ íŠ¸ë™ ì„ íƒ ì•Œê³ ë¦¬ì¦˜
- í”Œë ˆì´ì–´ ì„ í˜¸ë„ ê¸°ë°˜ íŠ¸ë™ ì¶”ì²œ

#### 2.4 ì •ë‹µ ì œì¶œ (submitAnswer)

```typescript
submitAnswer(room: Room, playerId: string, answer: string): {
  success: boolean;
  error?: string;
  result?: AnswerCheckResult
}
```

**êµ¬í˜„ ë¡œì§:**
```typescript
// 1. ê²€ì¦
if (!room.gameState.isPlaying) return { success: false, error: "ê²Œì„ì´ ì§„í–‰ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤" };
if (!room.gameState.currentTrack) return { success: false, error: "í˜„ì¬ ì¬ìƒ ì¤‘ì¸ íŠ¸ë™ì´ ì—†ìŠµë‹ˆë‹¤" };
if (!room.players.has(playerId)) return { success: false, error: "ë°©ì— ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í”Œë ˆì´ì–´ì…ë‹ˆë‹¤" };
if (room.gameState.answers.has(playerId)) return { success: false, error: "ì´ë¯¸ ë‹µì•ˆì„ ì œì¶œí–ˆìŠµë‹ˆë‹¤" };

// 2. ì •ë‹µ ì²´í¬ (ìœ ì‚¬ë„ ì•Œê³ ë¦¬ì¦˜)
const isCorrect = this.checkAnswer(answer, room.gameState.currentTrack.name);

// 3. ì‹œê°„ ê³„ì‚°
const submissionTime = Date.now();
const elapsedTime = submissionTime - room.gameState.roundStartTime;

// 4. ì ìˆ˜ ê³„ì‚°
const score = isCorrect ? this.calculateScore(elapsedTime, room.settings.roundInterval) : 0;

// 5. ìŠ¤íŠ¸ë¦­ ì—…ë°ì´íŠ¸
const currentStreak = room.gameState.streaks.get(playerId) || 0;
const newStreak = isCorrect ? currentStreak + 1 : 0;
room.gameState.streaks.set(playerId, newStreak);

// 6. ëˆ„ì  ì ìˆ˜ ì—…ë°ì´íŠ¸
const currentScore = room.gameState.scores.get(playerId) || 0;
const streakBonus = newStreak > 1 ? (newStreak - 1) * 100 : 0;
const totalScore = currentScore + score + streakBonus;
room.gameState.scores.set(playerId, totalScore);

// 7. ë‹µì•ˆ ê¸°ë¡
room.gameState.answers.set(playerId, submissionTime);

return {
  success: true,
  result: {
    isCorrect,
    score: score + streakBonus,
    message: isCorrect ? `ì •ë‹µì…ë‹ˆë‹¤! +${score + streakBonus}ì ` : `ì˜¤ë‹µì…ë‹ˆë‹¤. ì •ë‹µ: ${room.gameState.currentTrack.name}`,
    streak: newStreak,
  },
};
```

**ì„¤ê³„ ê²°ì •:**
- ì œì¶œ ì‹œê°„ì„ ì •í™•í•˜ê²Œ ê¸°ë¡í•˜ì—¬ ê³µì •í•œ ì ìˆ˜ ê³„ì‚°
- ìŠ¤íŠ¸ë¦­ ë³´ë„ˆìŠ¤ë¡œ ì—°ì† ì •ë‹µì— ëŒ€í•œ ë³´ìƒ
- ì¦‰ê°ì ì¸ í”¼ë“œë°± ì œê³µ (ì •ë‹µ ì—¬ë¶€ + ì ìˆ˜ + ë©”ì‹œì§€)

#### 2.5 ë¼ìš´ë“œ ì¢…ë£Œ (endRound)

```typescript
endRound(room: Room): { success: boolean; error?: string; result?: RoundResult }
```

**êµ¬í˜„ ë¡œì§:**
```typescript
// 1. ê²€ì¦
if (!room.gameState.isPlaying) return { success: false, error: "ê²Œì„ì´ ì§„í–‰ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤" };
if (!room.gameState.currentTrack) return { success: false, error: "ì¢…ë£Œí•  ë¼ìš´ë“œê°€ ì—†ìŠµë‹ˆë‹¤" };

// 2. ë‹µì•ˆ ìˆ˜ì§‘
const answers: AnswerSubmission[] = [];
const correctAnswers: AnswerSubmission[] = [];

for (const [playerId, submissionTime] of room.gameState.answers.entries()) {
  const player = room.players.get(playerId);
  if (!player) continue;

  const elapsedTime = submissionTime - room.gameState.roundStartTime;
  const score = room.gameState.scores.get(playerId) || 0;

  const submission: AnswerSubmission = {
    playerId,
    answer: "",  // TODO: ì‹¤ì œ ë‹µì•ˆ í…ìŠ¤íŠ¸ ì €ì¥ í•„ìš”
    timestamp: elapsedTime,
    isCorrect: true,  // TODO: ì •ë‹µ ì—¬ë¶€ ì €ì¥ í•„ìš”
    score,
  };

  answers.push(submission);
  correctAnswers.push(submission);
}

// 3. ê²°ê³¼ ìƒì„±
const result: RoundResult = {
  roundNumber: room.gameState.currentRound,
  track: room.gameState.currentTrack,
  answers,
  correctAnswers,
  scores: new Map(room.gameState.scores),
  streaks: new Map(room.gameState.streaks),
};

// 4. í˜„ì¬ íŠ¸ë™ ì´ˆê¸°í™”
room.gameState.currentTrack = null;

return { success: true, result };
```

**TODO í•­ëª©:**
- ë‹µì•ˆ í…ìŠ¤íŠ¸ë¥¼ ë³„ë„ë¡œ ì €ì¥í•˜ëŠ” êµ¬ì¡° ê°œì„ 
- ì •ë‹µ ì—¬ë¶€ë¥¼ submitAnswerì—ì„œ ì €ì¥í•˜ë„ë¡ ìˆ˜ì •

#### 2.6 ê²Œì„ ì¢…ë£Œ (endGame)

```typescript
endGame(room: Room): { success: boolean; error?: string; result?: GameResult }
```

**êµ¬í˜„ ë¡œì§:**
```typescript
// 1. ê²€ì¦
if (!room.gameState.isPlaying) return { success: false, error: "ì§„í–‰ ì¤‘ì¸ ê²Œì„ì´ ì—†ìŠµë‹ˆë‹¤" };

// 2. ìµœì¢… ì ìˆ˜ ì§‘ê³„
const finalScores = Array.from(room.players.values()).map((player) => {
  const score = room.gameState.scores.get(player.id) || 0;
  const streak = room.gameState.streaks.get(player.id) || 0;
  const correctAnswers = Math.floor(score / 1000);  // ê°„ì†Œí™”ëœ ê³„ì‚°

  return {
    playerId: player.id,
    nickname: player.nickname,
    score,
    correctAnswers,
    maxStreak: streak,
  };
});

// 3. ì ìˆ˜ ìˆœìœ¼ë¡œ ì •ë ¬
finalScores.sort((a, b) => b.score - a.score);

// 4. ìš°ìŠ¹ì ê²°ì •
const winner = finalScores.length > 0 ? {
  playerId: finalScores[0].playerId,
  nickname: finalScores[0].nickname,
  score: finalScores[0].score,
} : null;

// 5. ê²Œì„ ê²°ê³¼ ìƒì„±
const gameResult: GameResult = {
  roomCode: room.code,
  totalRounds: room.gameState.totalRounds,
  finalScores,
  winner,
  playedAt: Date.now(),
};

// 6. íˆìŠ¤í† ë¦¬ ì €ì¥
this.gameHistory.push(gameResult);

// 7. ê²Œì„ ìƒíƒœ ì´ˆê¸°í™”
room.gameState.isPlaying = false;
room.gameState.currentRound = 0;
room.gameState.currentTrack = null;
room.gameState.roundStartTime = 0;
room.gameState.answers.clear();

return { success: true, result: gameResult };
```

**ì„¤ê³„ í¬ì¸íŠ¸:**
- ê²Œì„ íˆìŠ¤í† ë¦¬ë¥¼ ìë™ìœ¼ë¡œ ì €ì¥
- ê²Œì„ ìƒíƒœë¥¼ ê¹”ë”í•˜ê²Œ ì´ˆê¸°í™”í•˜ì—¬ ì¬ì‚¬ìš© ê°€ëŠ¥
- ìš°ìŠ¹ì ì •ë³´ë¥¼ ë³„ë„ë¡œ ì €ì¥í•˜ì—¬ ë¹ ë¥¸ ì¡°íšŒ

---

## í•µì‹¬ ì•Œê³ ë¦¬ì¦˜

### 1. ì •ë‹µ ì²´í¬ ì•Œê³ ë¦¬ì¦˜

#### 1.1 ì „ì²´ íë¦„

```typescript
checkAnswer(userAnswer: string, correctAnswer: string): boolean {
  // 1. ì •ê·œí™”
  const normalizedUser = normalize(userAnswer);
  const normalizedCorrect = normalize(correctAnswer);

  // 2. ì™„ì „ ì¼ì¹˜ ì²´í¬
  if (normalizedUser === normalizedCorrect) return true;

  // 3. ë¶€ë¶„ ì¼ì¹˜ ì²´í¬ (3ì ì´ìƒ)
  if (normalizedCorrect.includes(normalizedUser) && normalizedUser.length >= 3) {
    return true;
  }

  // 4. ìœ ì‚¬ë„ ì²´í¬ (80% ì´ìƒ)
  const similarity = this.calculateSimilarity(normalizedUser, normalizedCorrect);
  return similarity > 0.8;
}
```

#### 1.2 ì •ê·œí™” í•¨ìˆ˜

```typescript
const normalize = (str: string): string => {
  return str
    .toLowerCase()                           // ì†Œë¬¸ì ë³€í™˜
    .replace(/[\s\-_.()[\]{}!?,;:'"]/g, "")  // ê³µë°±/íŠ¹ìˆ˜ë¬¸ì ì œê±°
    .trim();                                 // ì•ë’¤ ê³µë°± ì œê±°
};
```

**ì œê±°ë˜ëŠ” ë¬¸ì:**
- ê³µë°±: ` `
- í•˜ì´í”ˆ: `-`
- ì–¸ë”ìŠ¤ì½”ì–´: `_`
- ë§ˆì¹¨í‘œ: `.`
- ê´„í˜¸: `()`, `[]`, `{}`
- êµ¬ë‘ì : `!`, `?`, `,`, `;`, `:`
- ë”°ì˜´í‘œ: `'`, `"`

**ì˜ˆì‹œ:**
```typescript
normalize("Dyna-mite!")        // "dynamite"
normalize(" Butter ")          // "butter"
normalize("DNA(ë°©íƒ„ì†Œë…„ë‹¨)")   // "dnaë°©íƒ„ì†Œë…„ë‹¨"
```

#### 1.3 Levenshtein Distance ì•Œê³ ë¦¬ì¦˜

**ê°œë…:**
ë‘ ë¬¸ìì—´ ê°„ì˜ ìµœì†Œ í¸ì§‘ ê±°ë¦¬ë¥¼ ê³„ì‚°í•˜ëŠ” ì•Œê³ ë¦¬ì¦˜ì…ë‹ˆë‹¤.
- ì‚½ì… (Insertion)
- ì‚­ì œ (Deletion)
- ì¹˜í™˜ (Substitution)

**êµ¬í˜„:**
```typescript
private levenshteinDistance(str1: string, str2: string): number {
  const matrix: number[][] = [];

  // ì´ˆê¸°í™”
  for (let i = 0; i <= str2.length; i++) {
    matrix[i] = [i];
  }
  for (let j = 0; j <= str1.length; j++) {
    matrix[0][j] = j;
  }

  // ë™ì  í”„ë¡œê·¸ë˜ë°
  for (let i = 1; i <= str2.length; i++) {
    for (let j = 1; j <= str1.length; j++) {
      if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
        matrix[i][j] = matrix[i - 1][j - 1];  // ê°™ìœ¼ë©´ ë¹„ìš© 0
      } else {
        matrix[i][j] = Math.min(
          matrix[i - 1][j - 1] + 1,  // ì¹˜í™˜
          matrix[i][j - 1] + 1,      // ì‚½ì…
          matrix[i - 1][j] + 1       // ì‚­ì œ
        );
      }
    }
  }

  return matrix[str2.length][str1.length];
}
```

**ì˜ˆì‹œ:**
```
"kitten" â†’ "sitting"

    ""  s  i  t  t  i  n  g
""   0  1  2  3  4  5  6  7
k    1  1  2  3  4  5  6  7
i    2  2  1  2  3  4  5  6
t    3  3  2  1  2  3  4  5
t    4  4  3  2  1  2  3  4
e    5  5  4  3  2  2  3  4
n    6  6  5  4  3  3  2  3

í¸ì§‘ ê±°ë¦¬ = 3 (kâ†’s, eâ†’i, ëì— g ì‚½ì…)
```

#### 1.4 ìœ ì‚¬ë„ ê³„ì‚°

```typescript
private calculateSimilarity(str1: string, str2: string): number {
  const longer = str1.length > str2.length ? str1 : str2;
  const shorter = str1.length > str2.length ? str2 : str1;

  if (longer.length === 0) {
    return 1.0;  // ë‘˜ ë‹¤ ë¹ˆ ë¬¸ìì—´ì´ë©´ ì™„ì „ ì¼ì¹˜
  }

  const editDistance = this.levenshteinDistance(longer, shorter);
  return (longer.length - editDistance) / longer.length;
}
```

**ê³„ì‚° ê³µì‹:**
```
ìœ ì‚¬ë„ = (ê¸´ ë¬¸ìì—´ ê¸¸ì´ - í¸ì§‘ ê±°ë¦¬) / ê¸´ ë¬¸ìì—´ ê¸¸ì´
```

**ì˜ˆì‹œ:**
```typescript
calculateSimilarity("dynamite", "dyanmite")
// í¸ì§‘ ê±°ë¦¬ = 2 (aì™€ nì˜ ìˆœì„œ ë°”ë€œ)
// ìœ ì‚¬ë„ = (8 - 2) / 8 = 0.75

calculateSimilarity("dynamite", "dynamit")
// í¸ì§‘ ê±°ë¦¬ = 1 (e í•˜ë‚˜ ëˆ„ë½)
// ìœ ì‚¬ë„ = (8 - 1) / 8 = 0.875 â†’ ì •ë‹µ!
```

**ì •ë‹µ ê¸°ì¤€:**
- ìœ ì‚¬ë„ > 0.8 (80% ì´ìƒ) â†’ ì •ë‹µ
- ìœ ì‚¬ë„ â‰¤ 0.8 â†’ ì˜¤ë‹µ

---

### 2. ì ìˆ˜ ê³„ì‚° ì•Œê³ ë¦¬ì¦˜

#### 2.1 ì ìˆ˜ ê³„ì‚° ê³µì‹

```typescript
calculateScore(elapsedTime: number, roundInterval: number): number {
  const baseScore = 1000;                      // ê¸°ë³¸ ì ìˆ˜
  const maxTime = roundInterval * 1000;        // ì´ˆë¥¼ ë°€ë¦¬ì´ˆë¡œ ë³€í™˜

  // ì‹œê°„ ë³´ë„ˆìŠ¤: ë¹ ë¥¼ìˆ˜ë¡ ë†’ì€ ì ìˆ˜
  const timeBonus = Math.max(0, Math.floor((maxTime - elapsedTime) / maxTime * 500));

  return baseScore + timeBonus;
}
```

**ì ìˆ˜ êµ¬ì„±:**
```
ì´ ì ìˆ˜ = ê¸°ë³¸ ì ìˆ˜ + ì‹œê°„ ë³´ë„ˆìŠ¤ + ìŠ¤íŠ¸ë¦­ ë³´ë„ˆìŠ¤

1. ê¸°ë³¸ ì ìˆ˜: 1000ì  (ê³ ì •)
2. ì‹œê°„ ë³´ë„ˆìŠ¤: 0 ~ 500ì 
   - ì¦‰ì‹œ ì œì¶œ (0ì´ˆ): +500ì 
   - ë§ˆì§€ë§‰ ìˆœê°„ ì œì¶œ (30ì´ˆ): +0ì 
   - ì„ í˜• ê°ì†Œ: (ë‚¨ì€ ì‹œê°„ / ì „ì²´ ì‹œê°„) * 500
3. ìŠ¤íŠ¸ë¦­ ë³´ë„ˆìŠ¤: (ì—°ì† ì •ë‹µ ìˆ˜ - 1) * 100ì 
   - 1ì—°ì†: +0ì 
   - 2ì—°ì†: +100ì 
   - 3ì—°ì†: +200ì 
```

#### 2.2 ì ìˆ˜ ê³„ì‚° ì˜ˆì‹œ

**ì‹œë‚˜ë¦¬ì˜¤ 1: ë¹ ë¥¸ ì •ë‹µ (5ì´ˆ)**
```typescript
ë¼ìš´ë“œ ì‹œê°„: 30ì´ˆ
ê²½ê³¼ ì‹œê°„: 5ì´ˆ (5000ms)
ë‚¨ì€ ì‹œê°„: 25ì´ˆ (25000ms)

ê¸°ë³¸ ì ìˆ˜: 1000ì 
ì‹œê°„ ë³´ë„ˆìŠ¤: (25000 / 30000) * 500 = 416ì 
ìŠ¤íŠ¸ë¦­ ë³´ë„ˆìŠ¤: 0ì  (ì²« ì •ë‹µ)

ì´ ì ìˆ˜: 1416ì 
```

**ì‹œë‚˜ë¦¬ì˜¤ 2: ëŠë¦° ì •ë‹µ (28ì´ˆ)**
```typescript
ë¼ìš´ë“œ ì‹œê°„: 30ì´ˆ
ê²½ê³¼ ì‹œê°„: 28ì´ˆ (28000ms)
ë‚¨ì€ ì‹œê°„: 2ì´ˆ (2000ms)

ê¸°ë³¸ ì ìˆ˜: 1000ì 
ì‹œê°„ ë³´ë„ˆìŠ¤: (2000 / 30000) * 500 = 33ì 
ìŠ¤íŠ¸ë¦­ ë³´ë„ˆìŠ¤: 0ì  (ì²« ì •ë‹µ)

ì´ ì ìˆ˜: 1033ì 
```

**ì‹œë‚˜ë¦¬ì˜¤ 3: ì—°ì† ì •ë‹µ (10ì´ˆ, 3ì—°ì†)**
```typescript
ë¼ìš´ë“œ ì‹œê°„: 30ì´ˆ
ê²½ê³¼ ì‹œê°„: 10ì´ˆ (10000ms)
ë‚¨ì€ ì‹œê°„: 20ì´ˆ (20000ms)
í˜„ì¬ ìŠ¤íŠ¸ë¦­: 3

ê¸°ë³¸ ì ìˆ˜: 1000ì 
ì‹œê°„ ë³´ë„ˆìŠ¤: (20000 / 30000) * 500 = 333ì 
ìŠ¤íŠ¸ë¦­ ë³´ë„ˆìŠ¤: (3 - 1) * 100 = 200ì 

ì´ ì ìˆ˜: 1533ì 
```

#### 2.3 ì ìˆ˜ ê³¡ì„  ê·¸ë˜í”„

```
ì ìˆ˜
1500 â”¤                                             â—  (3ì—°ì†, 0ì´ˆ)
     â”‚                                            â•±
1400 â”¤                                          â•±
     â”‚                                        â•±
1300 â”¤                                      â•±
     â”‚                                    â•±
1200 â”¤                                  â•±
     â”‚                                â•±
1100 â”¤                              â•±
     â”‚                            â•±
1000 â”¤â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—                    (ê¸°ë³¸)
     â”‚                            â•²
 900 â”¤                              â•²
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ ì‹œê°„
     0ì´ˆ                15ì´ˆ               30ì´ˆ
```

---

## í…ŒìŠ¤íŠ¸ ì „ëµ

### 1. í…ŒìŠ¤íŠ¸ êµ¬ì¡°

```
packages/server/src/__tests__/game.test.ts

ì´ 36ê°œ í…ŒìŠ¤íŠ¸
â”œâ”€ startGame (4ê°œ)
â”‚  â”œâ”€ should start game successfully
â”‚  â”œâ”€ should reject if game already started
â”‚  â”œâ”€ should reject if no players
â”‚  â””â”€ should initialize all player scores to 0
â”‚
â”œâ”€ startRound (5ê°œ)
â”‚  â”œâ”€ should start round successfully
â”‚  â”œâ”€ should reject if game not started
â”‚  â”œâ”€ should reject if no tracks available
â”‚  â”œâ”€ should increment round number
â”‚  â””â”€ should reject if all rounds completed
â”‚
â”œâ”€ submitAnswer (7ê°œ)
â”‚  â”œâ”€ should accept correct answer
â”‚  â”œâ”€ should reject incorrect answer but record it
â”‚  â”œâ”€ should accept similar answers (case insensitive)
â”‚  â”œâ”€ should reject if player already submitted
â”‚  â”œâ”€ should update streak on consecutive correct answers
â”‚  â”œâ”€ should reset streak on wrong answer
â”‚  â””â”€ should calculate score based on time
â”‚
â”œâ”€ endRound (3ê°œ)
â”‚  â”œâ”€ should end round successfully
â”‚  â”œâ”€ should collect all player answers
â”‚  â””â”€ should reject if game not started
â”‚
â”œâ”€ endGame (5ê°œ)
â”‚  â”œâ”€ should end game successfully
â”‚  â”œâ”€ should determine winner correctly
â”‚  â”œâ”€ should sort final scores correctly
â”‚  â”œâ”€ should save game to history
â”‚  â””â”€ should reset game state
â”‚
â”œâ”€ Answer checking algorithm (7ê°œ)
â”‚  â”œâ”€ should accept exact match
â”‚  â”œâ”€ should accept case insensitive match
â”‚  â”œâ”€ should accept match with extra spaces
â”‚  â”œâ”€ should accept match with special characters removed
â”‚  â”œâ”€ should reject completely wrong answer
â”‚  â”œâ”€ should accept partial match if long enough
â”‚  â””â”€ should reject very short partial match
â”‚
â”œâ”€ Score calculation (2ê°œ)
â”‚  â”œâ”€ should give higher score for faster answer
â”‚  â””â”€ should add streak bonus
â”‚
â””â”€ Playlist management & Game history (3ê°œ)
   â”œâ”€ should have test playlist available
   â”œâ”€ should return undefined for non-existent playlist
   â””â”€ should track completed games
```

### 2. í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€

**ì „ì²´ í†µê³¼ìœ¨: 100% (36/36)**

```bash
 âœ“ src/__tests__/game.test.ts (36 tests) 143ms
   âœ“ should start game successfully
   âœ“ should reject if game already started
   âœ“ should reject if no players
   âœ“ should initialize all player scores to 0
   âœ“ should start round successfully
   ... (31ê°œ í…ŒìŠ¤íŠ¸ ìƒëµ)
   âœ“ should track completed games

 Test Files  1 passed (1)
      Tests  36 passed (36)
   Duration  494ms
```

### 3. ì£¼ìš” í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤

#### 3.1 ì •ë‹µ ì²´í¬ ì•Œê³ ë¦¬ì¦˜ í…ŒìŠ¤íŠ¸

```typescript
describe("Answer checking algorithm", () => {
  it("should accept exact match", () => {
    const result = gameService.submitAnswer(testRoom, "host1", "Dynamite");
    expect(result.result?.isCorrect).toBe(true);
  });

  it("should accept case insensitive match", () => {
    const result = gameService.submitAnswer(testRoom, "host1", "dynamite");
    expect(result.result?.isCorrect).toBe(true);
  });

  it("should accept match with extra spaces", () => {
    const result = gameService.submitAnswer(testRoom, "host1", " Dynamite ");
    expect(result.result?.isCorrect).toBe(true);
  });

  it("should accept match with special characters removed", () => {
    const result = gameService.submitAnswer(testRoom, "host1", "Dyna-mite!");
    expect(result.result?.isCorrect).toBe(true);
  });

  it("should accept partial match if long enough", () => {
    const result = gameService.submitAnswer(testRoom, "host1", "Dyna");
    expect(result.result?.isCorrect).toBe(true);
  });

  it("should reject very short partial match", () => {
    const result = gameService.submitAnswer(testRoom, "host1", "Dy");
    expect(result.result?.isCorrect).toBe(false);
  });
});
```

#### 3.2 ìŠ¤íŠ¸ë¦­ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸

```typescript
it("should update streak on consecutive correct answers", () => {
  // Round 1
  gameService.submitAnswer(testRoom, "host1", testRoom.gameState.currentTrack!.name);
  expect(testRoom.gameState.streaks.get("host1")).toBe(1);

  // Round 2
  gameService.endRound(testRoom);
  gameService.startRound(testRoom, testTracks);
  gameService.submitAnswer(testRoom, "host1", testRoom.gameState.currentTrack!.name);
  expect(testRoom.gameState.streaks.get("host1")).toBe(2);
});

it("should reset streak on wrong answer", () => {
  // Correct answer
  gameService.submitAnswer(testRoom, "host1", testRoom.gameState.currentTrack!.name);
  expect(testRoom.gameState.streaks.get("host1")).toBe(1);

  // Wrong answer
  gameService.endRound(testRoom);
  gameService.startRound(testRoom, testTracks);
  gameService.submitAnswer(testRoom, "host1", "Wrong Answer");
  expect(testRoom.gameState.streaks.get("host1")).toBe(0);
});
```

#### 3.3 ì ìˆ˜ ê³„ì‚° í…ŒìŠ¤íŠ¸

```typescript
it("should give higher score for faster answer", () => {
  // Fast answer (1 second ago)
  testRoom.gameState.roundStartTime = Date.now() - 1000;
  const result1 = gameService.submitAnswer(testRoom, "host1", testRoom.gameState.currentTrack!.name);
  const score1 = result1.result!.score;

  // Slow answer (10 seconds ago)
  const testRoom2 = roomService.createRoom("host2", "TestHost2", testSettings);
  gameService.startGame(testRoom2);
  gameService.startRound(testRoom2, testTracks);
  testRoom2.gameState.roundStartTime = Date.now() - 10000;
  const result2 = gameService.submitAnswer(testRoom2, "host2", testRoom2.gameState.currentTrack!.name);
  const score2 = result2.result!.score;

  expect(score1).toBeGreaterThan(score2);
});
```

### 4. Vitest ì„¤ì •

#### vitest.config.ts

```typescript
import { defineConfig } from "vitest/config";

export default defineConfig({
  test: {
    globals: true,
    environment: "node",
    include: ["src/**/*.test.ts"],
    coverage: {
      provider: "v8",
      reporter: ["text", "json", "html"],
    },
  },
});
```

#### package.json ìŠ¤í¬ë¦½íŠ¸

```json
{
  "scripts": {
    "test": "vitest run",
    "test:watch": "vitest",
    "test:ui": "vitest --ui"
  }
}
```

---

## ì‚¬ìš© ê°€ì´ë“œ

### 1. GameService ì‚¬ìš© ì˜ˆì‹œ

#### 1.1 ê¸°ë³¸ ê²Œì„ íë¦„

```typescript
import { gameService } from "./services/game.js";
import { roomService } from "./services/room.js";

// 1. ë°© ìƒì„±
const room = roomService.createRoom("host1", "Player1", {
  maxPlayers: 8,
  roundInterval: 30,
  playlistId: "test-playlist"
});

// 2. ê²Œì„ ì‹œì‘
const startResult = gameService.startGame(room);
if (!startResult.success) {
  console.error(startResult.error);
  return;
}

// 3. íŠ¸ë™ ë¡œë“œ (ì‹¤ì œë¡œëŠ” YouTube APIì—ì„œ ê°€ì ¸ì˜´)
const tracks: Track[] = [
  {
    id: "track1",
    name: "Dynamite",
    artist: "BTS",
    uploadDate: "2020-08-21",
    year: "2020",
    embedUrl: "https://www.youtube.com/embed/gdZLi9oWNZg",
    duration: 199,
    startSeconds: 0,
    endSeconds: 30,
  },
  // ... ë” ë§ì€ íŠ¸ë™
];

// 4. ë¼ìš´ë“œ ì‹œì‘
const roundResult = gameService.startRound(room, tracks);
if (roundResult.success) {
  console.log(`Round ${roundResult.roundNumber} started!`);
  console.log(`Track: ${roundResult.track!.name}`);
}

// 5. í”Œë ˆì´ì–´ë“¤ì´ ë‹µì•ˆ ì œì¶œ
const answer1 = gameService.submitAnswer(room, "host1", "Dynamite");
console.log(answer1.result?.message);  // "ì •ë‹µì…ë‹ˆë‹¤! +1499ì "

// 6. ë¼ìš´ë“œ ì¢…ë£Œ
const endRoundResult = gameService.endRound(room);
console.log(`${endRoundResult.result!.correctAnswers.length} players got it right!`);

// 7. ê²Œì„ ì¢…ë£Œ
const gameResult = gameService.endGame(room);
console.log(`Winner: ${gameResult.result!.winner?.nickname} (${gameResult.result!.winner?.score} points)`);
```

#### 1.2 Socket.IOì™€ í†µí•© (í–¥í›„ ì‘ì—…)

```typescript
// socket/handlers/game.handler.ts
import { Server, Socket } from "socket.io";
import { gameService } from "../../services/game.js";
import { roomService } from "../../services/room.js";

export function handleStartGame(io: Server, socket: Socket) {
  socket.on("start-game", (data, callback) => {
    const { roomCode } = data;

    // ë°© ì¡°íšŒ
    const room = roomService.getRoom(roomCode);
    if (!room) {
      callback({ success: false, error: "ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" });
      return;
    }

    // ë°©ì¥ ê¶Œí•œ ì²´í¬
    if (room.hostId !== socket.id) {
      callback({ success: false, error: "ë°©ì¥ë§Œ ê²Œì„ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤" });
      return;
    }

    // ê²Œì„ ì‹œì‘
    const result = gameService.startGame(room);
    if (!result.success) {
      callback({ success: false, error: result.error });
      return;
    }

    // ëª¨ë“  í”Œë ˆì´ì–´ì—ê²Œ ê²Œì„ ì‹œì‘ ì•Œë¦¼
    io.to(roomCode).emit("game-started", {
      totalRounds: room.gameState.totalRounds,
      players: Array.from(room.players.values()),
    });

    callback({ success: true });
  });
}

export function handleStartRound(io: Server, socket: Socket) {
  socket.on("start-round", async (data, callback) => {
    const { roomCode } = data;

    const room = roomService.getRoom(roomCode);
    if (!room) {
      callback({ success: false, error: "ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" });
      return;
    }

    // íŠ¸ë™ ë¡œë“œ (YouTube API)
    const tracks = await loadTracksFromPlaylist(room.settings.playlistId);

    // ë¼ìš´ë“œ ì‹œì‘
    const result = gameService.startRound(room, tracks);
    if (!result.success) {
      callback({ success: false, error: result.error });
      return;
    }

    // íŠ¸ë™ ì •ë³´ë¥¼ ìˆ¨ê¸°ê³  í´ë¼ì´ì–¸íŠ¸ì— ì „ì†¡
    const hiddenTrack = {
      id: result.track!.id,
      embedUrl: result.track!.embedUrl,
      startSeconds: result.track!.startSeconds,
      endSeconds: result.track!.endSeconds,
      // nameê³¼ artistëŠ” ìˆ¨ê¹€
    };

    // ëª¨ë“  í”Œë ˆì´ì–´ì—ê²Œ ë¼ìš´ë“œ ì‹œì‘ ì•Œë¦¼
    io.to(roomCode).emit("round-started", {
      roundNumber: result.roundNumber,
      track: hiddenTrack,
      duration: room.settings.roundInterval,
    });

    callback({ success: true });
  });
}

export function handleSubmitAnswer(io: Server, socket: Socket) {
  socket.on("submit-answer", (data, callback) => {
    const { roomCode, answer } = data;

    const room = roomService.getRoom(roomCode);
    if (!room) {
      callback({ success: false, error: "ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" });
      return;
    }

    // ì •ë‹µ ì œì¶œ
    const result = gameService.submitAnswer(room, socket.id, answer);
    if (!result.success) {
      callback({ success: false, error: result.error });
      return;
    }

    // ì œì¶œìì—ê²Œ ê²°ê³¼ ì „ì†¡
    callback({
      success: true,
      result: result.result,
    });

    // ë‹¤ë¥¸ í”Œë ˆì´ì–´ë“¤ì—ê²Œ ì œì¶œ ì•Œë¦¼ (ì •ë‹µì€ ìˆ¨ê¹€)
    socket.to(roomCode).emit("answer-submitted", {
      playerId: socket.id,
      timestamp: Date.now(),
    });

    // ëª¨ë“  í”Œë ˆì´ì–´ê°€ ì œì¶œí–ˆëŠ”ì§€ ì²´í¬
    if (room.gameState.answers.size === room.players.size) {
      // ìë™ìœ¼ë¡œ ë¼ìš´ë“œ ì¢…ë£Œ
      setTimeout(() => {
        const endResult = gameService.endRound(room);
        io.to(roomCode).emit("round-ended", {
          result: serializeRoundResult(endResult.result!),
        });
      }, 1000);
    }
  });
}
```

### 2. í…ŒìŠ¤íŠ¸ ì‹¤í–‰

```bash
# ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰
npm test

# Watch ëª¨ë“œ (ê°œë°œ ì¤‘)
npm run test:watch

# UI ëª¨ë“œ
npm run test:ui

# íŠ¹ì • í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
npm test -- game.test.ts
```

### 3. ë””ë²„ê¹…

GameServiceëŠ” console.logë¥¼ í†µí•´ ì¤‘ìš”í•œ ì´ë²¤íŠ¸ë¥¼ ë¡œê¹…í•©ë‹ˆë‹¤:

```typescript
// ê²Œì„ ì‹œì‘
console.log(`ğŸ® Game started in room ${room.code}`);
console.log(`ğŸ“‹ Playlist: ${playlist.name} (${playlist.roundCount} rounds)`);

// ë¼ìš´ë“œ ì‹œì‘
console.log(`ğŸµ Round ${room.gameState.currentRound}/${room.gameState.totalRounds} started`);
console.log(`ğŸ§ Track: ${selectedTrack.name} - ${selectedTrack.artist}`);

// ì •ë‹µ ì œì¶œ
console.log(`ğŸ“ ${player?.nickname} submitted: "${answer}" - ${isCorrect ? "âœ…" : "âŒ"} (${elapsedTime}ms)`);

// ë¼ìš´ë“œ ì¢…ë£Œ
console.log(`ğŸ Round ${room.gameState.currentRound} ended`);
console.log(`âœ… ${correctAnswers.length}/${room.players.size} players answered correctly`);

// ê²Œì„ ì¢…ë£Œ
console.log(`ğŸŠ Game ended in room ${room.code}`);
if (winner) {
  console.log(`ğŸ‘‘ Winner: ${winner.nickname} (${winner.score} points)`);
}
```

---

## í–¥í›„ í™•ì¥ ë°©ì•ˆ

### 1. ë‹µì•ˆ ì €ì¥ ê°œì„ 

**í˜„ì¬ ë¬¸ì œ:**
- `gameState.answers`ì— ì œì¶œ ì‹œê°„ë§Œ ì €ì¥
- ì‹¤ì œ ë‹µì•ˆ í…ìŠ¤íŠ¸ì™€ ì •ë‹µ ì—¬ë¶€ë¥¼ ë³„ë„ë¡œ ì €ì¥í•˜ì§€ ì•ŠìŒ

**ê°œì„  ë°©ì•ˆ:**
```typescript
// ìƒˆë¡œìš´ íƒ€ì… ì •ì˜
interface StoredAnswer {
  playerId: string;
  answer: string;
  timestamp: number;
  isCorrect: boolean;
  score: number;
}

// GameState ìˆ˜ì •
interface GameState {
  // ...
  answers: Map<string, StoredAnswer>;  // ê¸°ì¡´: Map<string, number>
}

// submitAnswer ìˆ˜ì •
submitAnswer(room: Room, playerId: string, answer: string) {
  // ...
  room.gameState.answers.set(playerId, {
    playerId,
    answer,
    timestamp: submissionTime,
    isCorrect,
    score: score + streakBonus,
  });
  // ...
}
```

### 2. ì¤‘ë³µ íŠ¸ë™ ë°©ì§€

**í˜„ì¬ ë¬¸ì œ:**
- ëœë¤ ì„ íƒë§Œ í•˜ë¯€ë¡œ ê°™ì€ íŠ¸ë™ì´ ì—¬ëŸ¬ ë²ˆ ë‚˜ì˜¬ ìˆ˜ ìˆìŒ

**ê°œì„  ë°©ì•ˆ:**
```typescript
interface GameState {
  // ...
  usedTrackIds: Set<string>;  // ì´ë¯¸ ì‚¬ìš©ëœ íŠ¸ë™ ID
}

startRound(room: Room, tracks: Track[]) {
  // ì‚¬ìš©í•˜ì§€ ì•Šì€ íŠ¸ë™ë§Œ í•„í„°ë§
  const availableTracks = tracks.filter(
    track => !room.gameState.usedTrackIds.has(track.id)
  );

  if (availableTracks.length === 0) {
    // ëª¨ë“  íŠ¸ë™ì„ ë‹¤ ì¼ìœ¼ë©´ ë¦¬ì…‹
    room.gameState.usedTrackIds.clear();
    availableTracks = tracks;
  }

  const selectedTrack = availableTracks[Math.floor(Math.random() * availableTracks.length)];
  room.gameState.usedTrackIds.add(selectedTrack.id);
  // ...
}
```

### 3. ë‚œì´ë„ ì‹œìŠ¤í…œ

**ê°œì„  ë°©ì•ˆ:**
```typescript
interface RoomSettings {
  // ...
  difficulty: "easy" | "medium" | "hard";
}

// ë‚œì´ë„ì— ë”°ë¥¸ ì •ë‹µ ì²´í¬ ê¸°ì¤€ ì¡°ì •
checkAnswer(userAnswer: string, correctAnswer: string, difficulty: string): boolean {
  const threshold = {
    easy: 0.7,    // 70% ìœ ì‚¬ë„
    medium: 0.8,  // 80% ìœ ì‚¬ë„ (í˜„ì¬)
    hard: 0.9,    // 90% ìœ ì‚¬ë„
  }[difficulty];

  const similarity = this.calculateSimilarity(normalizedUser, normalizedCorrect);
  return similarity > threshold;
}

// ë‚œì´ë„ì— ë”°ë¥¸ ì ìˆ˜ ë°°ìœ¨
calculateScore(elapsedTime: number, roundInterval: number, difficulty: string): number {
  const baseScore = 1000;
  const timeBonus = Math.max(0, Math.floor((maxTime - elapsedTime) / maxTime * 500));

  const multiplier = {
    easy: 1.0,
    medium: 1.5,
    hard: 2.0,
  }[difficulty];

  return Math.floor((baseScore + timeBonus) * multiplier);
}
```

### 4. íŒíŠ¸ ì‹œìŠ¤í…œ

**ê°œì„  ë°©ì•ˆ:**
```typescript
interface GameState {
  // ...
  hintsUsed: Map<string, number>;  // í”Œë ˆì´ì–´ë³„ íŒíŠ¸ ì‚¬ìš© íšŸìˆ˜
}

interface RoomSettings {
  // ...
  allowHints: boolean;
  maxHintsPerRound: number;
}

// íŒíŠ¸ ìš”ì²­
requestHint(room: Room, playerId: string): { success: boolean; hint?: string; error?: string } {
  if (!room.settings.allowHints) {
    return { success: false, error: "íŒíŠ¸ê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤" };
  }

  const hintsUsed = room.gameState.hintsUsed.get(playerId) || 0;
  if (hintsUsed >= room.settings.maxHintsPerRound) {
    return { success: false, error: "íŒíŠ¸ë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤" };
  }

  const track = room.gameState.currentTrack;
  if (!track) {
    return { success: false, error: "í˜„ì¬ ì¬ìƒ ì¤‘ì¸ íŠ¸ë™ì´ ì—†ìŠµë‹ˆë‹¤" };
  }

  // íŒíŠ¸ ìƒì„± (ì˜ˆ: ì œëª©ì˜ ì²« ê¸€ì)
  const hint = this.generateHint(track.name, hintsUsed);

  room.gameState.hintsUsed.set(playerId, hintsUsed + 1);

  return { success: true, hint };
}

private generateHint(trackName: string, hintLevel: number): string {
  // ë ˆë²¨ì— ë”°ë¼ ë‹¤ë¥¸ íŒíŠ¸ ì œê³µ
  switch (hintLevel) {
    case 0:
      return `ì²« ê¸€ì: ${trackName.charAt(0)}`;
    case 1:
      return `ê¸€ì ìˆ˜: ${trackName.length}ì`;
    case 2:
      return `ì¼ë¶€: ${trackName.substring(0, 3)}...`;
    default:
      return "ë” ì´ìƒ íŒíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤";
  }
}
```

### 5. í†µê³„ ë° ë¶„ì„

**ê°œì„  ë°©ì•ˆ:**
```typescript
interface PlayerStats {
  totalGames: number;
  wins: number;
  totalScore: number;
  averageScore: number;
  correctAnswers: number;
  totalAnswers: number;
  accuracy: number;
  maxStreak: number;
  favoriteGenre: string;
}

class GameService {
  private playerStats: Map<string, PlayerStats>;

  updatePlayerStats(playerId: string, gameResult: GameResult) {
    const stats = this.playerStats.get(playerId) || this.createDefaultStats();

    stats.totalGames += 1;
    if (gameResult.winner?.playerId === playerId) {
      stats.wins += 1;
    }

    const playerResult = gameResult.finalScores.find(s => s.playerId === playerId);
    if (playerResult) {
      stats.totalScore += playerResult.score;
      stats.correctAnswers += playerResult.correctAnswers;
      stats.totalAnswers += gameResult.totalRounds;
      stats.maxStreak = Math.max(stats.maxStreak, playerResult.maxStreak);
    }

    stats.averageScore = stats.totalScore / stats.totalGames;
    stats.accuracy = stats.correctAnswers / stats.totalAnswers;

    this.playerStats.set(playerId, stats);
  }

  getPlayerStats(playerId: string): PlayerStats | undefined {
    return this.playerStats.get(playerId);
  }

  getLeaderboard(limit: number = 10): PlayerStats[] {
    return Array.from(this.playerStats.values())
      .sort((a, b) => b.averageScore - a.averageScore)
      .slice(0, limit);
  }
}
```

### 6. ë°ì´í„° ì˜êµ¬í™” (Redis)

**ê°œì„  ë°©ì•ˆ:**
```typescript
import { Redis } from "ioredis";

class GameService {
  private redis: Redis;

  async saveGameResult(gameResult: GameResult): Promise<void> {
    const key = `game:${gameResult.roomCode}:${gameResult.playedAt}`;
    await this.redis.setex(
      key,
      60 * 60 * 24 * 7,  // 7ì¼ ë³´ê´€
      JSON.stringify(gameResult)
    );

    // ìµœê·¼ ê²Œì„ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
    await this.redis.lpush("games:recent", key);
    await this.redis.ltrim("games:recent", 0, 99);  // ìµœê·¼ 100ê°œë§Œ ìœ ì§€
  }

  async getRecentGames(limit: number = 10): Promise<GameResult[]> {
    const keys = await this.redis.lrange("games:recent", 0, limit - 1);
    const results = await Promise.all(
      keys.map(key => this.redis.get(key))
    );

    return results
      .filter(r => r !== null)
      .map(r => JSON.parse(r!));
  }
}
```

### 7. ì‹¤ì‹œê°„ ìˆœìœ„ ì—…ë°ì´íŠ¸

**ê°œì„  ë°©ì•ˆ:**
```typescript
// Socket ì´ë²¤íŠ¸ë¡œ ì‹¤ì‹œê°„ ìˆœìœ„ ë¸Œë¡œë“œìºìŠ¤íŠ¸
function broadcastLiveRanking(io: Server, roomCode: string, room: Room) {
  const ranking = Array.from(room.players.values()).map(player => ({
    playerId: player.id,
    nickname: player.nickname,
    score: room.gameState.scores.get(player.id) || 0,
    streak: room.gameState.streaks.get(player.id) || 0,
  })).sort((a, b) => b.score - a.score);

  io.to(roomCode).emit("ranking-updated", { ranking });
}

// submitAnswer í›„ í˜¸ì¶œ
submitAnswer(room: Room, playerId: string, answer: string) {
  // ... ê¸°ì¡´ ë¡œì§

  // ìˆœìœ„ ì—…ë°ì´íŠ¸ ë¸Œë¡œë“œìºìŠ¤íŠ¸
  if (io) {
    broadcastLiveRanking(io, room.code, room);
  }

  return result;
}
```

---

## ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­

### 1. ì‹œê°„ ë³µì¡ë„

**í˜„ì¬ êµ¬í˜„:**
```typescript
startGame()          â†’ O(n)   // n = í”Œë ˆì´ì–´ ìˆ˜
startRound()         â†’ O(1)   // ëœë¤ ì„ íƒ
submitAnswer()       â†’ O(m*k)  // m = ì •ë‹µ ê¸¸ì´, k = ë‹µì•ˆ ê¸¸ì´ (Levenshtein)
endRound()           â†’ O(n)   // n = ì œì¶œí•œ í”Œë ˆì´ì–´ ìˆ˜
endGame()            â†’ O(n log n)  // n = í”Œë ˆì´ì–´ ìˆ˜ (ì •ë ¬)
```

**ìµœì í™” ë°©ì•ˆ:**
- Levenshtein distance ê³„ì‚° ìºì‹±
- ì •ë‹µ ì²´í¬ ì‹œ ë¹ ë¥¸ ê²½ë¡œ ìš°ì„  (ì™„ì „ ì¼ì¹˜, ë¶€ë¶„ ì¼ì¹˜)

### 2. ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰

```
GameService ì¸ìŠ¤í„´ìŠ¤ë‹¹:
â”œâ”€ playlists: ~1KB Ã— í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ê°œìˆ˜
â”œâ”€ gameHistory: ~5KB Ã— ê²Œì„ ê°œìˆ˜
â””â”€ ì´ ë©”ëª¨ë¦¬: < 100MB (1000ê°œ ê²Œì„ ê¸°ì¤€)
```

### 3. í™•ì¥ì„±

**í˜„ì¬ ì œí•œ:**
- ë‹¨ì¼ ì„œë²„ ë©”ëª¨ë¦¬ ê¸°ë°˜
- ì„œë²„ ì¬ì‹œì‘ ì‹œ íˆìŠ¤í† ë¦¬ ì†ì‹¤

**ê°œì„  ë°©í–¥:**
- Redisë¡œ ê²Œì„ ìƒíƒœ ì €ì¥
- PostgreSQLë¡œ íˆìŠ¤í† ë¦¬ ì˜êµ¬ ì €ì¥
- ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ (ê²Œì„ ì„œë¹„ìŠ¤ ë¶„ë¦¬)

---

## ê²°ë¡ 

### ë‹¬ì„±í•œ ëª©í‘œ

1. âœ… **ì™„ì „í•œ ê²Œì„ ë¡œì§**: ì‹œì‘ë¶€í„° ì¢…ë£Œê¹Œì§€ ì „ì²´ íë¦„ êµ¬í˜„
2. âœ… **ë˜‘ë˜‘í•œ ì •ë‹µ ì²´í¬**: Levenshtein distance ê¸°ë°˜ ìœ ì‚¬ë„ ê²€ì‚¬
3. âœ… **ê³µì •í•œ ì ìˆ˜ ì‹œìŠ¤í…œ**: ì‹œê°„ + ìŠ¤íŠ¸ë¦­ ë³´ë„ˆìŠ¤
4. âœ… **ê²¬ê³ í•œ ê²€ì¦**: ëª¨ë“  ë‹¨ê³„ì—ì„œ ì—ëŸ¬ ì²˜ë¦¬
5. âœ… **í¬ê´„ì ì¸ í…ŒìŠ¤íŠ¸**: 36ê°œ í…ŒìŠ¤íŠ¸ ëª¨ë‘ í†µê³¼
6. âœ… **íƒ€ì… ì•ˆì •ì„±**: TypeScriptë¡œ ì•ˆì „í•œ ê°œë°œ

### í•™ìŠµí•œ ë‚´ìš©

1. **ì•Œê³ ë¦¬ì¦˜ êµ¬í˜„**
   - Levenshtein distance ë™ì  í”„ë¡œê·¸ë˜ë°
   - ë¬¸ìì—´ ì •ê·œí™” ë° ìœ ì‚¬ë„ ê³„ì‚°
   - ì ìˆ˜ ê³„ì‚° ê³µì‹ ì„¤ê³„

2. **í…ŒìŠ¤íŠ¸ ì£¼ë„ ê°œë°œ**
   - Vitest í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬ ì‚¬ìš©
   - ì—£ì§€ ì¼€ì´ìŠ¤ ì»¤ë²„ë¦¬ì§€
   - ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„± íŒ¨í„´

3. **ì„œë¹„ìŠ¤ ì„¤ê³„**
   - ë‹¨ì¼ ì±…ì„ ì›ì¹™
   - ê²€ì¦ ë¡œì§ ë¶„ë¦¬
   - í™•ì¥ ê°€ëŠ¥í•œ êµ¬ì¡°

### ë‹¤ìŒ ë‹¨ê³„

1. **Socket.IO ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬** (ìš°ì„ ìˆœìœ„: ë†’ìŒ)
   - `start-game`: ê²Œì„ ì‹œì‘ ì´ë²¤íŠ¸
   - `start-round`: ë¼ìš´ë“œ ì‹œì‘ ì´ë²¤íŠ¸
   - `submit-answer`: ì •ë‹µ ì œì¶œ ì´ë²¤íŠ¸
   - `end-round`: ë¼ìš´ë“œ ì¢…ë£Œ ì´ë²¤íŠ¸
   - `end-game`: ê²Œì„ ì¢…ë£Œ ì´ë²¤íŠ¸

2. **YouTube API í†µí•©** (ìš°ì„ ìˆœìœ„: ë†’ìŒ)
   - í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì—ì„œ íŠ¸ë™ ë¡œë“œ
   - íŠ¸ë™ ì •ë³´ íŒŒì‹±
   - ì¬ìƒ URL ìƒì„±

3. **ê²Œì„ UI êµ¬í˜„** (ìš°ì„ ìˆœìœ„: ì¤‘ê°„)
   - ê²Œì„ ëŒ€ê¸°ì‹¤
   - ê²Œì„ ì§„í–‰ í™”ë©´
   - ê²°ê³¼ í™”ë©´

4. **ë°ì´í„° ì˜êµ¬í™”** (ìš°ì„ ìˆœìœ„: ë‚®ìŒ)
   - Redis ë„ì…
   - ê²Œì„ íˆìŠ¤í† ë¦¬ ì €ì¥
   - í”Œë ˆì´ì–´ í†µê³„

---

**ì‘ì„±ì**: Claude (AI Assistant)
**ê²€í† **: GameService êµ¬í˜„ ì™„ë£Œ ë° í…ŒìŠ¤íŠ¸ í†µê³¼
**ë²„ì „**: 1.0.0
**ìµœì¢… ìˆ˜ì •ì¼**: 2025-10-30
